{"version":3,"sources":["../../src/raster/raster.ts"],"names":["RasterLayer","parserDataItem","getSource","data","dataArray","createTexture2D","rendererService","rasterTexture","width","height","format","gl","LUMINANCE","type","FLOAT","aniso","getLayerConfig","rampColors","imageData","colorTexture","flipY","models","buildRasterModel","opacity","heightRatio","coordinates","min","max","forEach","model","draw","uniforms","u_opacity","u_texture","u_min","u_width","u_height","u_max","u_heightRatio","u_colorTexture","u_extent","properties","minimum","maximum","source","sourceFeature","triangulation","shaderModuleService","registerModule","vs","rasterVert","fs","rasterFrag","getModule","createAttribute","createElements","createBuffer","createModel","attributes","a_Position","buffer","vertices","size","primitive","TRIANGLES","depth","enable","elements","indices","UNSIGNED_INT","count","length","BaseLayer"],"mappings":"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","sourcesContent":["import {\n  AttributeType,\n  gl,\n  IEncodeFeature,\n  ILayer,\n  ILayerPlugin,\n  IModelUniform,\n  IRasterParserDataItem,\n  IStyleAttributeService,\n  ITexture2D,\n  lazyInject,\n  TYPES,\n} from '@antv/l7-core';\n\nimport { generateColorRamp, IColorRamp } from '@antv/l7-utils';\nimport BaseLayer from '../core/BaseLayer';\nimport { RasterTriangulation } from './buffers/triangulation';\nimport rasterFrag from './shaders/raster_frag.glsl';\nimport rasterVert from './shaders/raster_vert.glsl';\ninterface IRasterLayerStyleOptions {\n  opacity: number;\n  min: number;\n  max: number;\n  extent: [number, number, number, number];\n  rampColors: IColorRamp;\n  heightRatio: number;\n}\n\nexport default class RasterLayer extends BaseLayer<IRasterLayerStyleOptions> {\n  public type: string = 'RasterLayer';\n  protected rasterTexture: ITexture2D;\n  protected colorTexture: ITexture2D;\n\n  public getAnimateUniforms(): IModelUniform {\n    return {};\n  }\n\n  public buildModels() {\n    const parserDataItem = this.getSource().data.dataArray[0];\n    const { createTexture2D } = this.rendererService;\n    this.rasterTexture = createTexture2D({\n      data: parserDataItem.data,\n      width: parserDataItem.width,\n      height: parserDataItem.height,\n      format: gl.LUMINANCE,\n      type: gl.FLOAT,\n      aniso: 4,\n    });\n    const { rampColors } = this.getLayerConfig();\n    const imageData = generateColorRamp(rampColors as IColorRamp);\n    this.colorTexture = createTexture2D({\n      data: imageData.data,\n      width: imageData.width,\n      height: imageData.height,\n      flipY: false,\n    });\n    this.models = [this.buildRasterModel()];\n  }\n  public renderModels() {\n    const { opacity, heightRatio = 10 } = this.getLayerConfig();\n    const parserDataItem = this.getSource().data.dataArray[0];\n    const { coordinates, width, height, min, max } = parserDataItem;\n    this.models.forEach((model) =>\n      model.draw({\n        uniforms: {\n          u_opacity: opacity || 1,\n          u_texture: this.rasterTexture,\n          u_min: min,\n          u_width: width,\n          u_height: height,\n          u_max: max,\n          u_heightRatio: heightRatio,\n          u_colorTexture: this.colorTexture,\n          u_extent: [...coordinates[0], ...coordinates[1]],\n        },\n      }),\n    );\n\n    return this;\n  }\n  protected getConfigSchema() {\n    return {\n      properties: {\n        opacity: {\n          type: 'number',\n          minimum: 0,\n          maximum: 1,\n        },\n      },\n    };\n  }\n\n  private buildRasterModel() {\n    const source = this.getSource();\n    const sourceFeature = source.data.dataArray[0];\n    const triangulation = RasterTriangulation(sourceFeature);\n    this.shaderModuleService.registerModule('raster', {\n      vs: rasterVert,\n      fs: rasterFrag,\n    });\n\n    const { vs, fs, uniforms } = this.shaderModuleService.getModule('raster');\n    const {\n      createAttribute,\n      createElements,\n      createBuffer,\n      createModel,\n    } = this.rendererService;\n    return createModel({\n      vs,\n      fs,\n      attributes: {\n        a_Position: createAttribute({\n          buffer: createBuffer({\n            data: triangulation.vertices,\n            type: gl.FLOAT,\n          }),\n          size: 2,\n        }),\n      },\n      primitive: gl.TRIANGLES,\n      uniforms: {\n        ...uniforms,\n      },\n      depth: {\n        enable: true,\n      },\n      elements: createElements({\n        data: triangulation.indices,\n        type: gl.UNSIGNED_INT,\n        count: triangulation.indices.length,\n      }),\n    });\n  }\n}\n"],"file":"raster.js"}