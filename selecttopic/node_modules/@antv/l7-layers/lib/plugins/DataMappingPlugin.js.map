{"version":3,"sources":["../../src/plugins/DataMappingPlugin.ts"],"names":["DataMappingPlugin","TYPES","IGlobalConfigService","IMapService","IFontService","layer","styleAttributeService","hooks","init","tap","generateMaping","beforeRenderData","dataState","dataMappingNeedUpdate","beforeRender","layerModelNeedUpdate","bottomColor","getBottomColor","attributes","getLayerStyleAttributes","filter","getLayerStyleAttribute","dataArray","getSource","data","attributesToRemapping","attribute","needRemapping","filterData","scale","record","applyAttributeMapping","length","setEncodedData","mapping","undefined","getEncodedData","emit","predata","minimumColor","mappedData","map","i","preRecord","encodeRecord","id","_id","coordinates","forEach","values","name","c","Array","isArray","shape","fontService","getIconFontKey","adjustData2Amap2Coordinates","adjustData2SimpleCoordinates","mapService","version","Version","d","originCoordinates","lngLatToCoord","lngLatToCoords","SIMPLE","simpleCoordinate","unProjectCoordinates","simpleMapCoord","unproject","coords","coord","c1","co","push","scalers","params","field","hasOwnProperty","type","mappingResult"],"mappings":"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","sourcesContent":["import {\n  IEncodeFeature,\n  IFontService,\n  IGlobalConfigService,\n  ILayer,\n  ILayerPlugin,\n  ILngLat,\n  IMapService,\n  IParseDataItem,\n  IStyleAttribute,\n  IStyleAttributeService,\n  TYPES,\n} from '@antv/l7-core';\nimport { Version } from '@antv/l7-maps';\nimport { isColor, rgb2arr, unProjectFlat } from '@antv/l7-utils';\nimport { inject, injectable } from 'inversify';\nimport { cloneDeep } from 'lodash';\nimport 'reflect-metadata';\n\n@injectable()\nexport default class DataMappingPlugin implements ILayerPlugin {\n  @inject(TYPES.IGlobalConfigService)\n  private readonly configService: IGlobalConfigService;\n\n  @inject(TYPES.IMapService)\n  private readonly mapService: IMapService;\n\n  @inject(TYPES.IFontService)\n  private readonly fontService: IFontService;\n\n  public apply(\n    layer: ILayer,\n    {\n      styleAttributeService,\n    }: { styleAttributeService: IStyleAttributeService },\n  ) {\n    layer.hooks.init.tap('DataMappingPlugin', () => {\n      // 初始化重新生成 map\n      this.generateMaping(layer, { styleAttributeService });\n    });\n\n    layer.hooks.beforeRenderData.tap('DataMappingPlugin', () => {\n      layer.dataState.dataMappingNeedUpdate = false;\n      this.generateMaping(layer, { styleAttributeService });\n      return true;\n    });\n\n    // remapping before render\n    layer.hooks.beforeRender.tap('DataMappingPlugin', () => {\n      if (layer.layerModelNeedUpdate) {\n        return;\n      }\n      const bottomColor = layer.getBottomColor();\n      const attributes = styleAttributeService.getLayerStyleAttributes() || [];\n      const filter = styleAttributeService.getLayerStyleAttribute('filter');\n      const { dataArray } = layer.getSource().data;\n      const attributesToRemapping = attributes.filter(\n        (attribute) => attribute.needRemapping, // 如果filter变化\n      );\n      let filterData = dataArray;\n      // 数据过滤完 再执行数据映射\n      if (filter?.needRemapping && filter?.scale) {\n        filterData = dataArray.filter((record: IParseDataItem) => {\n          return this.applyAttributeMapping(filter, record, bottomColor)[0];\n        });\n      }\n      if (attributesToRemapping.length) {\n        // 过滤数据\n        if (filter?.needRemapping) {\n          layer.setEncodedData(\n            this.mapping(attributes, filterData, undefined, bottomColor),\n          );\n          filter.needRemapping = false;\n        } else {\n          layer.setEncodedData(\n            this.mapping(\n              attributesToRemapping,\n              filterData,\n              layer.getEncodedData(),\n              bottomColor,\n            ),\n          );\n        }\n        // 处理文本更新\n        layer.emit('remapping', null);\n      }\n    });\n  }\n  private generateMaping(\n    layer: ILayer,\n    {\n      styleAttributeService,\n    }: { styleAttributeService: IStyleAttributeService },\n  ) {\n    const bottomColor = layer.getBottomColor();\n    const attributes = styleAttributeService.getLayerStyleAttributes() || [];\n    const filter = styleAttributeService.getLayerStyleAttribute('filter');\n    const { dataArray } = layer.getSource().data;\n    let filterData = dataArray;\n    // 数据过滤完 再执行数据映射\n    if (filter?.scale) {\n      filterData = dataArray.filter((record: IParseDataItem) => {\n        return this.applyAttributeMapping(filter, record, bottomColor)[0];\n      });\n    }\n    layer.setEncodedData(\n      this.mapping(attributes, filterData, undefined, bottomColor),\n    );\n  }\n\n  private mapping(\n    attributes: IStyleAttribute[],\n    data: IParseDataItem[],\n    predata?: IEncodeFeature[],\n    minimumColor?: string,\n  ): IEncodeFeature[] {\n    // console.log('data', data)\n    const mappedData = data.map((record: IParseDataItem, i) => {\n      const preRecord = predata ? predata[i] : {};\n      const encodeRecord: IEncodeFeature = {\n        id: record._id,\n        coordinates: record.coordinates,\n        ...preRecord,\n      };\n      // console.log('attributes', attributes)\n      attributes\n        .filter((attribute) => attribute.scale !== undefined)\n        .forEach((attribute: IStyleAttribute) => {\n          // console.log('attribute', attribute)\n          // console.log('record', record)\n          let values = this.applyAttributeMapping(\n            attribute,\n            record,\n            minimumColor,\n          );\n          // console.log('values', values)\n          attribute.needRemapping = false;\n\n          // TODO: 支持每个属性配置 postprocess\n          if (attribute.name === 'color') {\n            // console.log('attribute', attribute)\n            values = values.map((c: unknown) => {\n              return rgb2arr(c as string);\n            });\n          }\n          // @ts-ignore\n          encodeRecord[attribute.name] =\n            Array.isArray(values) && values.length === 1 ? values[0] : values;\n\n          // 增加对 layer/text/iconfont unicode 映射的解析\n          if (attribute.name === 'shape') {\n            encodeRecord.shape = this.fontService.getIconFontKey(\n              encodeRecord[attribute.name] as string,\n            );\n          }\n        });\n      return encodeRecord;\n    }) as IEncodeFeature[];\n    // console.log('mappedData', mappedData)\n\n    // 调整数据兼容 Amap2.0\n    this.adjustData2Amap2Coordinates(mappedData);\n\n    // 调整数据兼容 SimpleCoordinates\n    this.adjustData2SimpleCoordinates(mappedData);\n    // console.log('mappedData', mappedData)\n    return mappedData;\n  }\n\n  private adjustData2Amap2Coordinates(mappedData: IEncodeFeature[]) {\n    // 根据地图的类型判断是否需要对点位数据进行处理, 若是高德2.0则需要对坐标进行相对偏移\n    if (\n      mappedData.length > 0 &&\n      this.mapService.version === Version['GAODE2.x']\n    ) {\n      if (typeof mappedData[0].coordinates[0] === 'number') {\n        // 单个的点数据\n        // @ts-ignore\n        mappedData\n          // TODO: 避免经纬度被重复计算导致坐标位置偏移\n          .filter((d) => !d.originCoordinates)\n          .map((d) => {\n            d.version = Version['GAODE2.x'];\n            // @ts-ignore\n            d.originCoordinates = cloneDeep(d.coordinates); // 为了兼容高德1.x 需要保存一份原始的经纬度坐标数据（许多上层逻辑依赖经纬度数据）\n            // @ts-ignore\n            d.coordinates = this.mapService.lngLatToCoord(d.coordinates);\n          });\n      } else {\n        // 连续的线、面数据\n        // @ts-ignore\n        mappedData\n          // TODO: 避免经纬度被重复计算导致坐标位置偏移\n          .filter((d) => !d.originCoordinates)\n          .map((d) => {\n            d.version = Version['GAODE2.x'];\n            // @ts-ignore\n            d.originCoordinates = cloneDeep(d.coordinates); // 为了兼容高德1.x 需要保存一份原始的经纬度坐标数据（许多上层逻辑依赖经纬度数据）\n            // @ts-ignore\n            d.coordinates = this.mapService.lngLatToCoords(d.coordinates);\n          });\n      }\n    }\n  }\n\n  private adjustData2SimpleCoordinates(mappedData: IEncodeFeature[]) {\n    if (mappedData.length > 0 && this.mapService.version === Version.SIMPLE) {\n      mappedData.map((d) => {\n        if (!d.simpleCoordinate) {\n          d.coordinates = this.unProjectCoordinates(d.coordinates);\n          d.simpleCoordinate = true;\n        }\n      });\n    }\n  }\n\n  private unProjectCoordinates(coordinates: any) {\n    if (typeof coordinates[0] === 'number') {\n      return this.mapService.simpleMapCoord.unproject(\n        coordinates as [number, number],\n      );\n    }\n\n    if (coordinates[0] && coordinates[0][0] instanceof Array) {\n      // @ts-ignore\n      const coords = [];\n      coordinates.map((coord: any) => {\n        // @ts-ignore\n        const c1 = [];\n        coord.map((co: any) => {\n          c1.push(\n            this.mapService.simpleMapCoord.unproject(co as [number, number]),\n          );\n        });\n        // @ts-ignore\n        coords.push(c1);\n      });\n      // @ts-ignore\n      return coords;\n    } else {\n      // @ts-ignore\n      const coords = [];\n      // @ts-ignore\n      coordinates.map((coord) => {\n        coords.push(\n          this.mapService.simpleMapCoord.unproject(coord as [number, number]),\n        );\n      });\n      // @ts-ignore\n      return coords;\n    }\n  }\n\n  private applyAttributeMapping(\n    attribute: IStyleAttribute,\n    record: { [key: string]: unknown },\n    minimumColor?: string,\n  ) {\n    if (!attribute.scale) {\n      return [];\n    }\n    const scalers = attribute?.scale?.scalers || [];\n    const params: unknown[] = [];\n\n    scalers.forEach(({ field }) => {\n      if (\n        record.hasOwnProperty(field) ||\n        attribute.scale?.type === 'variable'\n      ) {\n        // TODO:多字段，常量\n        params.push(record[field]);\n      }\n    });\n    // console.log('params', params)\n    // console.log('attribute', attribute)\n\n    const mappingResult = attribute.mapping ? attribute.mapping(params) : [];\n    if (attribute.name === 'color' && !isColor(mappingResult[0])) {\n      return [minimumColor];\n    }\n    return mappingResult;\n    // return attribute.mapping ? attribute.mapping(params) : [];\n  }\n}\n"],"file":"DataMappingPlugin.js"}