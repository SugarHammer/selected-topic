{"version":3,"sources":["../../src/regl/ReglModel.ts"],"names":["gl","blendEquationMap","blendFuncMap","cullFaceMap","depthFuncMap","primitiveMap","stencilFuncMap","stencilOpMap","ReglModel","reGl","options","vs","fs","attributes","uniforms","primitive","count","elements","depth","blend","stencil","cull","instances","reglUniforms","extractUniforms","Object","keys","forEach","uniformName","prop","reglAttributes","name","get","drawParams","frag","vert","undefined","TRIANGLES","initDepthDrawParams","initBlendDrawParams","initStencilDrawParams","initCullDrawParams","drawCommand","pickDrawParams","enable","drawPickCommand","pick","length","reglDrawProps","type","Array","isArray","BYTES_PER_ELEMENT","destroy","values","attr","destroyed","mask","func","LESS","range","equation","color","srcRGB","SRC_ALPHA","srcAlpha","dstRGB","ONE_MINUS_SRC_ALPHA","dstAlpha","rgb","FUNC_ADD","alpha","cmp","ALWAYS","ref","opFront","fail","KEEP","zfail","zpass","opBack","face","BACK","extractedUniforms","extractUniformsRecursively","uniformValue","prefix","childName","child","idx"],"mappings":"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","sourcesContent":["import {\n  gl,\n  IAttribute,\n  IModel,\n  IModelDrawOptions,\n  IModelInitializationOptions,\n  IUniform,\n} from '@antv/l7-core';\nimport regl from 'l7regl';\nimport { cloneDeep, extend, isPlainObject, isTypedArray } from 'lodash';\nimport {\n  blendEquationMap,\n  blendFuncMap,\n  cullFaceMap,\n  depthFuncMap,\n  primitiveMap,\n  stencilFuncMap,\n  stencilOpMap,\n} from './constants';\nimport ReglAttribute from './ReglAttribute';\nimport ReglElements from './ReglElements';\nimport ReglFramebuffer from './ReglFramebuffer';\nimport ReglTexture2D from './ReglTexture2D';\n\n/**\n * adaptor for regl.DrawCommand\n */\nexport default class ReglModel implements IModel {\n  private reGl: regl.Regl;\n  private destroyed: boolean = false;\n  private drawCommand: regl.DrawCommand;\n  private drawPickCommand: regl.DrawCommand;\n  private drawParams: regl.DrawConfig;\n  private options: IModelInitializationOptions;\n  private uniforms: {\n    [key: string]: IUniform;\n  } = {};\n\n  constructor(reGl: regl.Regl, options: IModelInitializationOptions) {\n    this.reGl = reGl;\n    const {\n      vs,\n      fs,\n      attributes,\n      uniforms,\n      primitive,\n      count,\n      elements,\n      depth,\n      blend,\n      stencil,\n      cull,\n      instances,\n    } = options;\n    const reglUniforms: { [key: string]: IUniform } = {};\n    this.options = options;\n    if (uniforms) {\n      this.uniforms = this.extractUniforms(uniforms);\n      Object.keys(uniforms).forEach((uniformName) => {\n        // use regl prop API\n        // @ts-ignore\n        reglUniforms[uniformName] = reGl.prop(uniformName);\n      });\n    }\n\n    const reglAttributes: { [key: string]: regl.Attribute } = {};\n    Object.keys(attributes).forEach((name: string) => {\n      reglAttributes[name] = (attributes[name] as ReglAttribute).get();\n    });\n    const drawParams: regl.DrawConfig = {\n      attributes: reglAttributes,\n      frag: fs,\n      uniforms: reglUniforms,\n      vert: vs,\n      blend: {},\n      primitive:\n        primitiveMap[primitive === undefined ? gl.TRIANGLES : primitive],\n    };\n    if (instances) {\n      drawParams.instances = instances;\n    }\n\n    // elements 中可能包含 count，此时不应传入\n    if (count) {\n      drawParams.count = count;\n    }\n\n    if (elements) {\n      drawParams.elements = (elements as ReglElements).get();\n    }\n\n    this.initDepthDrawParams({ depth }, drawParams);\n    this.initBlendDrawParams({ blend }, drawParams);\n    this.initStencilDrawParams({ stencil }, drawParams);\n    this.initCullDrawParams({ cull }, drawParams);\n\n    this.drawCommand = reGl(drawParams);\n\n    const pickDrawParams = cloneDeep(drawParams);\n\n    pickDrawParams.blend = {\n      ...pickDrawParams.blend,\n      enable: false,\n    };\n\n    pickDrawParams.stencil = {\n      ...pickDrawParams.stencil,\n      enable: false,\n    };\n\n    this.drawPickCommand = reGl(pickDrawParams);\n    this.drawParams = drawParams;\n  }\n\n  public addUniforms(uniforms: { [key: string]: IUniform }) {\n    this.uniforms = {\n      ...this.uniforms,\n      ...this.extractUniforms(uniforms),\n    };\n  }\n\n  public draw(options: IModelDrawOptions, pick?: boolean) {\n    // console.log('options', this.drawParams)\n    if (\n      this.drawParams.attributes &&\n      Object.keys(this.drawParams.attributes).length === 0\n    ) {\n      return;\n    }\n    const uniforms: {\n      [key: string]: IUniform;\n    } = {\n      ...this.uniforms,\n      ...this.extractUniforms(options.uniforms || {}),\n    };\n    const reglDrawProps: {\n      [key: string]:\n        | regl.Framebuffer\n        | regl.Texture2D\n        | number\n        | number[]\n        | boolean;\n    } = {};\n    Object.keys(uniforms).forEach((uniformName: string) => {\n      const type = typeof uniforms[uniformName];\n      if (\n        type === 'boolean' ||\n        type === 'number' ||\n        Array.isArray(uniforms[uniformName]) ||\n        // @ts-ignore\n        uniforms[uniformName].BYTES_PER_ELEMENT\n      ) {\n        reglDrawProps[uniformName] = uniforms[uniformName] as\n          | number\n          | number[]\n          | boolean;\n      } else {\n        reglDrawProps[uniformName] = (uniforms[uniformName] as\n          | ReglFramebuffer\n          | ReglTexture2D).get();\n      }\n    });\n    // TODO: 在进行拾取操作的绘制中，不应该使用叠加模式 - picking 根据拾取的颜色作为判断的输入，而叠加模式会产生新的，在 id 序列中不存在的颜色\n    if (!pick) {\n      this.drawCommand(reglDrawProps);\n    } else {\n      this.drawPickCommand(reglDrawProps);\n    }\n    // this.drawCommand(reglDrawProps);\n    // this.drawPickCommand(reglDrawProps);\n  }\n\n  public destroy() {\n    // @ts-ignore\n    this.drawParams.elements.destroy();\n    if (this.options.attributes) {\n      Object.values(this.options.attributes).forEach((attr: any) => {\n        // @ts-ignore\n        (attr as ReglAttribute).destroy();\n      });\n    }\n    this.destroyed = true;\n  }\n\n  /**\n   * @see https://github.com/regl-project/regl/blob/gh-pages/API.md#depth-buffer\n   */\n  private initDepthDrawParams(\n    { depth }: Pick<IModelInitializationOptions, 'depth'>,\n    drawParams: regl.DrawConfig,\n  ) {\n    if (depth) {\n      drawParams.depth = {\n        enable: depth.enable === undefined ? true : !!depth.enable,\n        mask: depth.mask === undefined ? true : !!depth.mask,\n        func: depthFuncMap[depth.func || gl.LESS],\n        range: depth.range || [0, 1],\n      };\n    }\n  }\n\n  /**\n   * @see https://github.com/regl-project/regl/blob/gh-pages/API.md#blending\n   */\n  private initBlendDrawParams(\n    { blend }: Pick<IModelInitializationOptions, 'blend'>,\n    drawParams: regl.DrawConfig,\n  ) {\n    if (blend) {\n      const { enable, func, equation, color = [0, 0, 0, 0] } = blend;\n      // @ts-ignore\n      drawParams.blend = {\n        enable: !!enable,\n        func: {\n          srcRGB: blendFuncMap[(func && func.srcRGB) || gl.SRC_ALPHA],\n          srcAlpha: blendFuncMap[(func && func.srcAlpha) || gl.SRC_ALPHA],\n          dstRGB: blendFuncMap[(func && func.dstRGB) || gl.ONE_MINUS_SRC_ALPHA],\n          dstAlpha:\n            blendFuncMap[(func && func.dstAlpha) || gl.ONE_MINUS_SRC_ALPHA],\n        },\n        equation: {\n          rgb: blendEquationMap[(equation && equation.rgb) || gl.FUNC_ADD],\n          alpha: blendEquationMap[(equation && equation.alpha) || gl.FUNC_ADD],\n        },\n        color,\n      };\n    }\n  }\n\n  /**\n   * @see https://github.com/regl-project/regl/blob/gh-pages/API.md#stencil\n   */\n  private initStencilDrawParams(\n    { stencil }: Pick<IModelInitializationOptions, 'stencil'>,\n    drawParams: regl.DrawConfig,\n  ) {\n    if (stencil) {\n      const {\n        enable,\n        mask = -1,\n        func = {\n          cmp: gl.ALWAYS,\n          ref: 0,\n          mask: -1,\n        },\n        opFront = {\n          fail: gl.KEEP,\n          zfail: gl.KEEP,\n          zpass: gl.KEEP,\n        },\n        opBack = {\n          fail: gl.KEEP,\n          zfail: gl.KEEP,\n          zpass: gl.KEEP,\n        },\n      } = stencil;\n      drawParams.stencil = {\n        enable: !!enable,\n        mask,\n        func: {\n          ...func,\n          cmp: stencilFuncMap[func.cmp],\n        },\n        opFront: {\n          fail: stencilOpMap[opFront.fail],\n          zfail: stencilOpMap[opFront.zfail],\n          zpass: stencilOpMap[opFront.zpass],\n        },\n        opBack: {\n          fail: stencilOpMap[opBack.fail],\n          zfail: stencilOpMap[opBack.zfail],\n          zpass: stencilOpMap[opBack.zpass],\n        },\n      };\n    }\n  }\n\n  /**\n   * @see https://github.com/regl-project/regl/blob/gh-pages/API.md#culling\n   */\n  private initCullDrawParams(\n    { cull }: Pick<IModelInitializationOptions, 'cull'>,\n    drawParams: regl.DrawConfig,\n  ) {\n    if (cull) {\n      const { enable, face = gl.BACK } = cull;\n      drawParams.cull = {\n        enable: !!enable,\n        face: cullFaceMap[face],\n      };\n    }\n  }\n\n  /**\n   * 考虑结构体命名, eg:\n   * a: { b: 1 }  ->  'a.b'\n   * a: [ { b: 1 } ] -> 'a[0].b'\n   */\n  private extractUniforms(uniforms: {\n    [key: string]: IUniform;\n  }): {\n    [key: string]: IUniform;\n  } {\n    const extractedUniforms = {};\n    Object.keys(uniforms).forEach((uniformName) => {\n      this.extractUniformsRecursively(\n        uniformName,\n        uniforms[uniformName],\n        extractedUniforms,\n        '',\n      );\n    });\n\n    return extractedUniforms;\n  }\n\n  private extractUniformsRecursively(\n    uniformName: string,\n    uniformValue: IUniform,\n    uniforms: {\n      [key: string]: IUniform;\n    },\n    prefix: string,\n  ) {\n    if (\n      uniformValue === null ||\n      typeof uniformValue === 'number' || // u_A: 1\n      typeof uniformValue === 'boolean' || // u_A: false\n      (Array.isArray(uniformValue) && typeof uniformValue[0] === 'number') || // u_A: [1, 2, 3]\n      isTypedArray(uniformValue) || // u_A: Float32Array\n      // @ts-ignore\n      uniformValue === '' ||\n      'resize' in uniformValue\n    ) {\n      uniforms[`${prefix && prefix + '.'}${uniformName}`] = uniformValue;\n      return;\n    }\n\n    // u_Struct.a.b.c\n    if (isPlainObject(uniformValue)) {\n      Object.keys(uniformValue).forEach((childName) => {\n        this.extractUniformsRecursively(\n          childName,\n          // @ts-ignore\n          uniformValue[childName],\n          uniforms,\n          `${prefix && prefix + '.'}${uniformName}`,\n        );\n      });\n    }\n\n    // u_Struct[0].a\n    if (Array.isArray(uniformValue)) {\n      uniformValue.forEach((child, idx) => {\n        Object.keys(child).forEach((childName) => {\n          this.extractUniformsRecursively(\n            childName,\n            // @ts-ignore\n            child[childName],\n            uniforms,\n            `${prefix && prefix + '.'}${uniformName}[${idx}]`,\n          );\n        });\n      });\n    }\n  }\n}\n"],"file":"ReglModel.js"}