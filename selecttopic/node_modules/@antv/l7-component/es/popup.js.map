{"version":3,"sources":["../src/popup.ts"],"names":["TYPES","anchorTranslate","anchorType","applyAnchorClass","bindAll","DOM","EventEmitter","Popup","cfg","popupOption","getdefault","scene","mapsService","get","IMapService","sceneSerive","ISceneService","on","update","closeOnClick","timeoutInstance","setTimeout","onClickClose","emit","remove","addTo","html","frag","window","document","createDocumentFragment","temp","createElement","child","innerHTML","firstChild","appendChild","setDOMContent","lngLat","Array","isArray","lng","lat","text","createTextNode","maxWidth","htmlNode","createContent","content","removeDom","container","off","clearTimeout","create","closeButton","closeButtonOffsets","style","right","top","setAttribute","addEventListener","tagName","className","el","undefined","node","parentNode","removeChild","offsets","anchor","BOTTOM","stopPropagation","e","hasPosition","popupContainer","getMarkerContainer","creatDom","tip","split","forEach","name","classList","add","type","whiteSpace","updatePosition","setTransform","pos","lngLatToContainer","left","x","y"],"mappings":"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","sourcesContent":["import {\n  ILngLat,\n  IMapService,\n  IPoint,\n  IPopup,\n  IPopupOption,\n  ISceneService,\n  TYPES,\n} from '@antv/l7-core';\nimport {\n  anchorTranslate,\n  anchorType,\n  applyAnchorClass,\n  bindAll,\n  DOM,\n} from '@antv/l7-utils';\nimport { EventEmitter } from 'eventemitter3';\nimport { Container } from 'inversify';\n\n/** colse event */\n\nexport default class Popup extends EventEmitter implements IPopup {\n  private popupOption: IPopupOption;\n  private mapsService: IMapService<unknown>;\n  private sceneSerive: ISceneService;\n  private lngLat: ILngLat;\n  private content: HTMLElement;\n  private closeButton: HTMLElement;\n  private timeoutInstance: any;\n  private container: HTMLElement;\n  private tip: HTMLElement;\n  private scene: Container;\n\n  constructor(cfg?: Partial<IPopupOption>) {\n    super();\n    this.popupOption = {\n      ...this.getdefault(),\n      ...cfg,\n    };\n    bindAll(['update', 'onClickClose', 'remove'], this);\n  }\n\n  public addTo(scene: Container) {\n    this.mapsService = scene.get<IMapService>(TYPES.IMapService);\n    this.sceneSerive = scene.get<ISceneService>(TYPES.ISceneService);\n    this.mapsService.on('camerachange', this.update);\n    this.mapsService.on('viewchange', this.update);\n    this.scene = scene;\n    this.update();\n    if (this.popupOption.closeOnClick) {\n      this.timeoutInstance = setTimeout(() => {\n        this.mapsService.on('click', this.onClickClose);\n      }, 30);\n    }\n    this.emit('open');\n    return this;\n  }\n\n  public close(): void {\n    this.remove();\n  }\n\n  public open(): void {\n    this.addTo(this.scene);\n  }\n\n  public setHTML(html: string) {\n    const frag = window.document.createDocumentFragment();\n    const temp = window.document.createElement('body');\n    let child: ChildNode | null;\n    temp.innerHTML = html;\n    while (true) {\n      child = temp.firstChild;\n      if (!child) {\n        break;\n      }\n      frag.appendChild(child);\n    }\n\n    return this.setDOMContent(frag);\n  }\n\n  public setLnglat(lngLat: ILngLat | number[]): this {\n    this.lngLat = lngLat as ILngLat;\n    if (Array.isArray(lngLat)) {\n      this.lngLat = {\n        lng: lngLat[0],\n        lat: lngLat[1],\n      };\n    }\n    if (this.mapsService) {\n      this.mapsService.on('camerachange', this.update);\n      this.mapsService.on('viewchange', this.update);\n    }\n    this.update();\n    return this;\n  }\n  public getLnglat(): ILngLat {\n    return this.lngLat;\n  }\n  public setText(text: string) {\n    return this.setDOMContent(window.document.createTextNode(text));\n  }\n\n  public setMaxWidth(maxWidth: string): this {\n    this.popupOption.maxWidth = maxWidth;\n    this.update();\n    return this;\n  }\n\n  public setDOMContent(htmlNode: ChildNode | DocumentFragment) {\n    this.createContent();\n    this.content.appendChild(htmlNode);\n    this.update();\n    return this;\n  }\n\n  // 移除popup\n  public remove() {\n    if (this.content) {\n      this.removeDom(this.content);\n    }\n\n    if (this.container) {\n      this.removeDom(this.container);\n      // @ts-ignore\n      delete this.container;\n    }\n    if (this.mapsService) {\n      // TODO: mapbox AMap 事件同步\n      this.mapsService.off('camerachange', this.update);\n      this.mapsService.off('viewchange', this.update);\n      this.mapsService.off('click', this.onClickClose);\n      // @ts-ignore\n      delete this.mapsService;\n    }\n    clearTimeout(this.timeoutInstance);\n    this.emit('close');\n    return this;\n  }\n  public isOpen() {\n    return !!this.mapsService;\n  }\n\n  private createContent() {\n    if (this.content) {\n      DOM.remove(this.content);\n    }\n    this.content = DOM.create('div', 'l7-popup-content', this.container);\n    if (this.popupOption.closeButton) {\n      this.closeButton = DOM.create(\n        'button',\n        'l7-popup-close-button',\n        this.content,\n      );\n\n      if (this.popupOption.closeButtonOffsets) {\n        // 关闭按钮的偏移\n        this.closeButton.style.right =\n          this.popupOption.closeButtonOffsets[0] + 'px';\n        this.closeButton.style.top =\n          this.popupOption.closeButtonOffsets[1] + 'px';\n      }\n\n      // this.closeButton.type = 'button';\n      this.closeButton.setAttribute('aria-label', 'Close popup');\n      this.closeButton.innerHTML = '&#215;';\n      this.closeButton.addEventListener('click', this.onClickClose);\n    }\n  }\n\n  private creatDom(tagName: string, className: string, container: HTMLElement) {\n    const el = window.document.createElement(tagName);\n    if (className !== undefined) {\n      el.className = className;\n    }\n    if (container) {\n      container.appendChild(el);\n    }\n    return el;\n  }\n\n  private removeDom(node: ChildNode) {\n    if (node.parentNode) {\n      node.parentNode.removeChild(node);\n    }\n  }\n\n  private getdefault() {\n    return {\n      closeButton: true,\n      closeOnClick: true,\n      maxWidth: '240px',\n      offsets: [0, 0],\n      anchor: anchorType.BOTTOM,\n      className: '',\n      stopPropagation: true,\n    };\n  }\n\n  private onClickClose(e: Event) {\n    if (e.stopPropagation) {\n      e.stopPropagation();\n    }\n    this.remove();\n  }\n\n  private update() {\n    const hasPosition = this.lngLat;\n    const { className, maxWidth, anchor } = this.popupOption;\n    if (!this.mapsService || !hasPosition || !this.content) {\n      return;\n    }\n    const popupContainer = this.mapsService.getMarkerContainer();\n    if (!this.container && popupContainer) {\n      this.container = this.creatDom(\n        'div',\n        'l7-popup',\n        popupContainer as HTMLElement,\n      );\n\n      this.tip = this.creatDom('div', 'l7-popup-tip', this.container);\n      this.container.appendChild(this.content);\n      if (className) {\n        className\n          .split(' ')\n          .forEach((name) => this.container.classList.add(name));\n      }\n\n      // 高德地图需要阻止事件冒泡 // 测试mapbox 地图不需要添加\n      const { stopPropagation } = this.popupOption;\n      if (stopPropagation) {\n        ['mousemove', 'mousedown', 'mouseup', 'click', 'dblclick'].forEach(\n          (type) => {\n            this.container.addEventListener(type, (e) => {\n              e.stopPropagation();\n            });\n          },\n        );\n      }\n\n      this.container.style.whiteSpace = 'nowrap';\n    }\n    if (maxWidth && this.container.style.maxWidth !== maxWidth) {\n      this.container.style.maxWidth = maxWidth;\n    }\n\n    this.updatePosition();\n    DOM.setTransform(this.container, `${anchorTranslate[anchor]}`);\n    applyAnchorClass(this.container, anchor, 'popup');\n  }\n\n  private updatePosition() {\n    if (!this.mapsService) {\n      return;\n    }\n    const { lng, lat } = this.lngLat;\n    const { offsets } = this.popupOption;\n    const pos = this.mapsService.lngLatToContainer([lng, lat]);\n    this.container.style.left = pos.x + offsets[0] + 'px';\n    this.container.style.top = pos.y - offsets[1] + 'px';\n  }\n}\n"],"file":"popup.js"}