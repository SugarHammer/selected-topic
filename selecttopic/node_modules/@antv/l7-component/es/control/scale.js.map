{"version":3,"sources":["../../src/control/scale.ts"],"names":["bindAll","DOM","lnglatDistance","Control","PositionType","Scale","cfg","position","BOTTOMLEFT","maxWidth","metric","updateWhenIdle","imperial","name","className","container","create","addScales","controlOption","mapsService","on","update","off","y","getSize","p1","containerToLngLat","p2","maxMeters","lng","lat","updateScales","updateMetric","updateImperial","meters","getRoundNum","label","updateScale","mScale","maxFeet","maxMiles","miles","feet","iScale","scale","text","ratio","style","width","Math","round","innerHTML","num","pow10","pow","floor","length","d"],"mappings":"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","sourcesContent":["import { IControlOption } from '@antv/l7-core';\nimport { bindAll, DOM, lnglatDistance } from '@antv/l7-utils';\n\nimport Control, { PositionType } from './BaseControl';\nexport interface IScaleControlOption extends IControlOption {\n  maxWidth: number;\n  metric: boolean;\n  updateWhenIdle: boolean;\n  imperial: boolean;\n}\nexport default class Scale extends Control {\n  private mScale: HTMLElement;\n  private iScale: HTMLElement;\n  constructor(cfg?: Partial<IScaleControlOption>) {\n    super(cfg);\n    bindAll(['update'], this);\n  }\n\n  public getDefault() {\n    return {\n      position: PositionType.BOTTOMLEFT,\n      maxWidth: 100,\n      metric: true,\n      updateWhenIdle: false,\n      imperial: false,\n      name: 'scale',\n    };\n  }\n\n  public onAdd() {\n    const className = 'l7-control-scale';\n    const container = DOM.create('div', className);\n    this.addScales(className + '-line', container);\n    const { updateWhenIdle } = this.controlOption;\n    // TODO: 高德地图和MapBox地图事件不一致问题\n    // 高德zoomchange\n    this.mapsService.on(updateWhenIdle ? 'moveend' : 'mapmove', this.update);\n    this.mapsService.on(updateWhenIdle ? 'zoomend' : 'zoomchange', this.update);\n    this.update();\n\n    return container;\n  }\n  public onRemove() {\n    const { updateWhenIdle } = this.controlOption;\n    this.mapsService.off(\n      updateWhenIdle ? 'zoomend' : 'zoomchange',\n      this.update,\n    );\n    this.mapsService.off(updateWhenIdle ? 'moveend' : 'mapmove', this.update);\n  }\n  public update() {\n    const mapsService = this.mapsService;\n    const { maxWidth } = this.controlOption;\n    const y = mapsService.getSize()[1] / 2;\n\n    const p1 = mapsService.containerToLngLat([0, y]);\n    const p2 = mapsService.containerToLngLat([maxWidth, y]);\n    const maxMeters = lnglatDistance([p1.lng, p1.lat], [p2.lng, p2.lat]);\n    this.updateScales(maxMeters);\n  }\n  public updateScales(maxMeters: number) {\n    const { metric, imperial } = this.controlOption;\n    if (metric && maxMeters) {\n      this.updateMetric(maxMeters);\n    }\n    if (imperial && maxMeters) {\n      this.updateImperial(maxMeters);\n    }\n  }\n  private updateMetric(maxMeters: number) {\n    const meters = this.getRoundNum(maxMeters);\n    const label = meters < 1000 ? meters + ' m' : meters / 1000 + ' km';\n    this.updateScale(this.mScale, label, meters / maxMeters);\n  }\n  private updateImperial(maxMeters: number) {\n    const maxFeet = maxMeters * 3.2808399;\n    let maxMiles: number;\n    let miles: number;\n    let feet: number;\n\n    if (maxFeet > 5280) {\n      maxMiles = maxFeet / 5280;\n      miles = this.getRoundNum(maxMiles);\n      this.updateScale(this.iScale, miles + ' mi', miles / maxMiles);\n    } else {\n      feet = this.getRoundNum(maxFeet);\n      this.updateScale(this.iScale, feet + ' ft', feet / maxFeet);\n    }\n  }\n  private updateScale(scale: HTMLElement, text: string, ratio: number) {\n    const { maxWidth } = this.controlOption;\n    scale.style.width = Math.round(maxWidth * ratio) + 'px';\n    scale.innerHTML = text;\n  }\n  private getRoundNum(num: number) {\n    const pow10 = Math.pow(10, (Math.floor(num) + '').length - 1);\n    let d = num / pow10;\n\n    d = d >= 10 ? 10 : d >= 5 ? 5 : d >= 3 ? 3 : d >= 2 ? 2 : 1;\n\n    return pow10 * d;\n  }\n  private addScales(className: string, container: HTMLElement) {\n    const { metric, imperial } = this.controlOption;\n    if (metric) {\n      this.mScale = DOM.create('div', className, container);\n    }\n    if (imperial) {\n      this.iScale = DOM.create('div', className, container);\n    }\n  }\n}\n"],"file":"scale.js"}