{"version":3,"sources":["../src/marker.ts"],"names":["TYPES","anchorTranslate","anchorType","applyAnchorClass","bindAll","DOM","EventEmitter","Marker","option","e","emit","type","target","data","markerOption","extData","lngLat","getDefault","init","element","undefined","anchor","BOTTOM","offsets","color","draggable","scene","mapsService","get","IMapService","sceneSerive","ISceneService","getMarkerContainer","appendChild","registerMarkerEvent","on","update","added","off","onMapClick","addDragHandler","onUp","unRegisterMarkerEvent","removeAllListeners","remove","popup","Array","isArray","lng","lat","setLnglat","el","once","setElement","openPopup","isOpen","addTo","closePopup","Error","updatePosition","setTransform","togglePopup","bounds","getBounds","pos","lngLatToContainer","style","display","whiteSpace","container","getContainer","containerWidth","containerHeight","scrollWidth","scrollHeight","Math","abs","x","newPos","y","left","top","defaultMarker","create","svg","document","createElementNS","setAttributeNS","path","addClass","Object","keys","forEach","key","value","addEventListener","eventHandle","getElement","removeEventListener"],"mappings":"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","sourcesContent":["import {\n  ILngLat,\n  IMapService,\n  IMarkerOption,\n  IPoint,\n  IPopup,\n  ISceneService,\n  TYPES,\n} from '@antv/l7-core';\nimport {\n  anchorTranslate,\n  anchorType,\n  applyAnchorClass,\n  bindAll,\n  DOM,\n} from '@antv/l7-utils';\nimport { EventEmitter } from 'eventemitter3';\nimport { Container } from 'inversify';\n\n//  marker 支持 dragger 未完成\nexport default class Marker extends EventEmitter {\n  private markerOption: IMarkerOption;\n  private defaultMarker: boolean;\n  private popup: IPopup;\n  private mapsService: IMapService<unknown>;\n  private sceneSerive: ISceneService;\n  private lngLat: ILngLat;\n  private scene: Container;\n  private added: boolean = false;\n  constructor(option?: Partial<IMarkerOption>) {\n    super();\n    this.markerOption = {\n      ...this.getDefault(),\n      ...option,\n    };\n    bindAll(['update', 'onMove', 'onUp', 'addDragHandler', 'onMapClick'], this);\n    this.init();\n  }\n\n  public getDefault() {\n    return {\n      element: undefined, // DOM element\n      anchor: anchorType.BOTTOM,\n      offsets: [0, 0],\n      color: '#5B8FF9',\n      draggable: false,\n    };\n  }\n\n  public addTo(scene: Container) {\n    // this.remove();\n    this.scene = scene;\n    this.mapsService = scene.get<IMapService>(TYPES.IMapService);\n    this.sceneSerive = scene.get<ISceneService>(TYPES.ISceneService);\n    const { element, draggable } = this.markerOption;\n    // this.sceneSerive.getSceneContainer().appendChild(element as HTMLElement);\n    this.mapsService.getMarkerContainer().appendChild(element as HTMLElement);\n    this.registerMarkerEvent(element as HTMLElement);\n    this.mapsService.on('camerachange', this.update); // 注册高德1.x 的地图事件监听\n    this.mapsService.on('viewchange', this.update); // 注册高德2.0 的地图事件监听\n    this.update();\n    this.added = true;\n    this.emit('added');\n    return this;\n  }\n\n  public remove() {\n    if (this.mapsService) {\n      this.mapsService.off('click', this.onMapClick);\n      this.mapsService.off('move', this.update);\n      this.mapsService.off('moveend', this.update);\n      this.mapsService.off('mousedown', this.addDragHandler);\n      this.mapsService.off('touchstart', this.addDragHandler);\n      this.mapsService.off('mouseup', this.onUp);\n      this.mapsService.off('touchend', this.onUp);\n    }\n    this.unRegisterMarkerEvent();\n    this.removeAllListeners();\n    const { element } = this.markerOption;\n    if (element) {\n      DOM.remove(element);\n    }\n    if (this.popup) {\n      this.popup.remove();\n    }\n    return this;\n  }\n\n  public setLnglat(lngLat: ILngLat | IPoint) {\n    this.lngLat = lngLat as ILngLat;\n    if (Array.isArray(lngLat)) {\n      this.lngLat = {\n        lng: lngLat[0],\n        lat: lngLat[1],\n      };\n    }\n\n    if (this.popup) {\n      this.popup.setLnglat(this.lngLat);\n    }\n    this.update();\n    return this;\n  }\n\n  public getLnglat(): ILngLat {\n    return this.lngLat;\n  }\n\n  public getElement(): HTMLElement {\n    return this.markerOption.element as HTMLElement;\n  }\n\n  public setElement(el: HTMLElement): this {\n    if (!this.added) {\n      this.once('added', () => {\n        this.setElement(el);\n      });\n      return this;\n    }\n    const { element } = this.markerOption;\n    if (element) {\n      DOM.remove(element);\n    }\n    this.markerOption.element = el;\n    this.init();\n    this.mapsService.getMarkerContainer().appendChild(el as HTMLElement);\n    this.registerMarkerEvent(el as HTMLElement);\n    this.update();\n    return this;\n  }\n\n  public openPopup(): this {\n    if (!this.added) {\n      this.once('added', () => {\n        this.openPopup();\n      });\n      return this;\n    }\n    const popup = this.popup;\n    if (!popup) {\n      return this;\n    }\n    if (!popup.isOpen()) {\n      popup.addTo(this.scene);\n    }\n    return this;\n  }\n\n  public closePopup(): this {\n    if (!this.added) {\n      this.once('added', () => {\n        this.closePopup();\n      });\n    }\n    const popup = this.popup;\n    if (popup) {\n      popup.remove();\n    }\n    return this;\n  }\n\n  public setPopup(popup: IPopup) {\n    this.popup = popup;\n    if (this.lngLat) {\n      this.popup.setLnglat(this.lngLat);\n    }\n    return this;\n  }\n\n  public togglePopup() {\n    const popup = this.popup;\n    if (!popup) {\n      return this;\n    } else if (popup.isOpen()) {\n      popup.remove();\n    } else {\n      popup.addTo(this.scene);\n    }\n    return this;\n  }\n\n  public getPopup() {\n    return this.popup;\n  }\n\n  public getOffset(): number[] {\n    return this.markerOption.offsets;\n  }\n\n  public setDraggable(draggable: boolean) {\n    throw new Error('Method not implemented.');\n  }\n\n  public isDraggable() {\n    return this.markerOption.draggable;\n  }\n\n  public getExtData() {\n    return this.markerOption.extData;\n  }\n\n  public setExtData(data: any) {\n    this.markerOption.extData = data;\n  }\n\n  private update() {\n    if (!this.mapsService) {\n      return;\n    }\n    const { element, anchor } = this.markerOption;\n    this.updatePosition();\n    DOM.setTransform(element as HTMLElement, `${anchorTranslate[anchor]}`);\n  }\n\n  private onMapClick(e: MouseEvent) {\n    const { element } = this.markerOption;\n    if (this.popup && element) {\n      this.togglePopup();\n    }\n  }\n\n  private updatePosition() {\n    if (!this.mapsService) {\n      return;\n    }\n    const { element, offsets } = this.markerOption;\n    const { lng, lat } = this.lngLat;\n    const bounds = this.mapsService.getBounds();\n    const pos = this.mapsService.lngLatToContainer([lng, lat]);\n\n    if (element) {\n      element.style.display = 'block';\n      element.style.whiteSpace = 'nowrap';\n      const container = this.mapsService.getContainer();\n      let containerWidth = 0;\n      let containerHeight = 0;\n      if (container) {\n        containerWidth = container.scrollWidth;\n        containerHeight = container.scrollHeight;\n      }\n      // 当前可视区域包含跨日界线\n      if (Math.abs(bounds[0][0]) > 180 || Math.abs(bounds[1][0]) > 180) {\n        if (pos.x > containerWidth) {\n          // 日界线右侧点左移\n          const newPos = this.mapsService.lngLatToContainer([lng - 360, lat]);\n          pos.x = newPos.x;\n        }\n        if (pos.x < 0) {\n          // 日界线左侧点右移\n          const newPos = this.mapsService.lngLatToContainer([lng + 360, lat]);\n          pos.x = newPos.x;\n        }\n      }\n      // 不在当前可视区域内隐藏点\n      if (\n        pos.x > containerWidth ||\n        pos.x < 0 ||\n        pos.y > containerHeight ||\n        pos.y < 0\n      ) {\n        element.style.display = 'none';\n      }\n      element.style.left = pos.x + offsets[0] + 'px';\n      element.style.top = pos.y - offsets[1] + 'px';\n    }\n  }\n\n  private init() {\n    let { element } = this.markerOption;\n    const { color, anchor } = this.markerOption;\n    if (!element) {\n      this.defaultMarker = true;\n      element = DOM.create('div') as HTMLDivElement;\n      this.markerOption.element = element;\n      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');\n      svg.setAttributeNS(null, 'display', 'block');\n      svg.setAttributeNS(null, 'height', '48px');\n      svg.setAttributeNS(null, 'width', '48px');\n      svg.setAttributeNS(null, 'viewBox', '0 0 1024 1024');\n\n      const path = document.createElementNS(\n        'http://www.w3.org/2000/svg',\n        'path',\n      );\n      path.setAttributeNS(\n        null,\n        'd',\n        'M512 490.666667C453.12 490.666667 405.333333 442.88 405.333333 384 405.333333 325.12 453.12 277.333333 512 277.333333 570.88 277.333333 618.666667 325.12 618.666667 384 618.666667 442.88 570.88 490.666667 512 490.666667M512 85.333333C346.88 85.333333 213.333333 218.88 213.333333 384 213.333333 608 512 938.666667 512 938.666667 512 938.666667 810.666667 608 810.666667 384 810.666667 218.88 677.12 85.333333 512 85.333333Z',\n      );\n      path.setAttributeNS(null, 'fill', color);\n      svg.appendChild(path);\n      element.appendChild(svg);\n    }\n    DOM.addClass(element, 'l7-marker');\n    Object.keys(this.markerOption.style || {}).forEach(\n      // @ts-ignore\n      (key: keyof CSSStyleDeclaration) => {\n        const value =\n          this.markerOption?.style && (this.markerOption?.style[key] as string);\n        if (element) {\n          // @ts-ignore\n          (element.style as CSSStyleDeclaration)[key] = value;\n        }\n      },\n    );\n\n    element.addEventListener('click', (e: MouseEvent) => {\n      this.onMapClick(e);\n    });\n    element.addEventListener('click', this.eventHandle);\n    applyAnchorClass(element, anchor, 'marker');\n  }\n  private registerMarkerEvent(element: HTMLElement) {\n    element.addEventListener('mousemove', this.eventHandle);\n    element.addEventListener('click', this.eventHandle);\n    element.addEventListener('mousedown', this.eventHandle);\n    element.addEventListener('mouseup', this.eventHandle);\n    element.addEventListener('dblclick', this.eventHandle);\n    element.addEventListener('contextmenu', this.eventHandle);\n    element.addEventListener('mouseover', this.eventHandle);\n    element.addEventListener('mouseout', this.eventHandle);\n  }\n  private unRegisterMarkerEvent() {\n    const element = this.getElement();\n    element.removeEventListener('mousemove', this.eventHandle);\n    element.removeEventListener('click', this.eventHandle);\n    element.removeEventListener('mousedown', this.eventHandle);\n    element.removeEventListener('mouseup', this.eventHandle);\n    element.removeEventListener('dblclick', this.eventHandle);\n    element.removeEventListener('contextmenu', this.eventHandle);\n    element.removeEventListener('mouseover', this.eventHandle);\n    element.removeEventListener('mouseout', this.eventHandle);\n  }\n\n  private eventHandle = (e: MouseEvent) => {\n    this.emit(e.type, {\n      target: e,\n      data: this.markerOption.extData,\n      lngLat: this.lngLat,\n    });\n  };\n  private addDragHandler(e: MouseEvent) {\n    throw new Error('Method not implemented.');\n  }\n\n  private onUp(e: MouseEvent) {\n    throw new Error('Method not implemented.');\n  }\n}\n"],"file":"marker.js"}