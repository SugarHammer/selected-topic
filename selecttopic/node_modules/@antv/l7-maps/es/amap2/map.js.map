{"version":3,"sources":["../../src/amap2/map.ts"],"names":["AMapLoader","CoordinateSystem","MapServiceEvent","TYPES","DOM","mat4","vec3","inject","injectable","SimpleMapCoord","toPaddingOptions","Version","MapTheme","Viewport","mapdivCount","window","forceWebGL","AMAP_API_KEY","AMAP_VERSION","AMAP_SCRIPT_ID","amapLoaded","pendingResolveQueue","AMapService","IGlobalConfigService","MapConfig","ICoordinateSystemService","IEventEmitter","e","map","customCoords","getCameraParams","fov","near","far","aspect","position","lookAt","up","emit","zoom","center","getCenter","cameraChangedCallback","viewport","syncWithMapCamera","cameraPosition","offsetOrigin","coordinateSystemService","setCoordinateSystem","P20_2","color","bgColor","sceneCenter","sceneCenterMKT","getProjection","project","lnglat","proj","setCenter","setCustomCoordCenter","_sub","lnglatArray","lnglats","lngLatToCoord","mapContainer","getContainer","amap","getElementsByClassName","style","zIndex","markerContainer","create","type","handler","indexOf","eventEmitter","on","off","size","getSize","getWidth","getHeight","getZoom","setZoom","options","padding","originCenter","w","h","px","lngLatToPixel","lng","lat","offsetPx","right","left","bottom","top","newCenter","pixelToLngLat","x","y","getLng","getLat","getPitch","getRotation","bounds","getBounds","NE","getNorthEast","SW","getSouthWest","maxlng","minlng","zooms","getZooms","rotation","setRotation","pitch","setPitch","zoomIn","zoomOut","p","panTo","panBy","extent","setBounds","AMap","Bounds","setZoomAndCenter","setMapStyle","getMapStyle","option","setStatus","pixel","lngLat","Pixel","lnglatToPixel","LngLat","getX","getY","ll","containerToLngLat","lngLatToContainer","altitude","z","rotate","scale","origin","flat","modelMatrix","translate","fromValues","rotateX","rotateY","rotateZ","config","id","minZoom","maxZoom","token","mapInstance","plugin","version","rest","Promise","resolve","resolveMap","$mapContainer","mapInitCenter","setTimeout","handleViewChanged","creatAmapContainer","mapConstructorOptions","mapStyle","viewMode","Map","console","warn","configService","getSceneWarninfo","push","load","key","plugins","then","length","forEach","r","catch","Error","outer","meterDis","GeometryUtil","distance","x1","y1","x2","y2","coordDis","Math","sqrt","pow","renderCanvas","layersPng","toDataURL","name","args","once","destroy","parentNode","removeChild","initAMap","$jsapi","document","getElementById","head","callback","a","b","$wrapper","$amapdiv","createElement","cssText","appendChild"],"mappings":"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","sourcesContent":["/**\n * AMapService\n */\nimport AMapLoader from '@amap/amap-jsapi-loader';\nimport {\n  Bounds,\n  CoordinateSystem,\n  ICameraOptions,\n  ICoordinateSystemService,\n  IGlobalConfigService,\n  ILngLat,\n  IMapConfig,\n  IMapService,\n  IMercator,\n  IPoint,\n  IStatusOptions,\n  IViewport,\n  MapServiceEvent,\n  MapStyle,\n  Point,\n  TYPES,\n} from '@antv/l7-core';\nimport { DOM } from '@antv/l7-utils';\nimport { mat4, vec2, vec3 } from 'gl-matrix';\nimport { inject, injectable } from 'inversify';\nimport 'reflect-metadata';\nimport { IAMapEvent, IAMapInstance } from '../../typings/index';\nimport { ISimpleMapCoord, SimpleMapCoord } from '../simpleMapCoord';\nimport { toPaddingOptions } from '../utils';\nimport { Version } from '../version';\nimport './logo.css';\nimport { MapTheme } from './theme';\nimport Viewport from './Viewport';\n\nlet mapdivCount = 0;\n// @ts-ignore\nwindow.forceWebGL = true;\n\n// const AMAP_API_KEY: string = '15cd8a57710d40c9b7c0e3cc120f1200';\nconst AMAP_API_KEY: string = 'ff533602d57df6f8ab3b0fea226ae52f';\n// const AMAP_VERSION: string = '1.4.15';\nconst AMAP_VERSION: string = '2.0';\n/**\n * 确保多个场景只引入一个高德地图脚本\n */\nconst AMAP_SCRIPT_ID: string = 'amap-script';\n/**\n * 高德地图脚本是否加载完毕\n */\nlet amapLoaded = false;\n/**\n * 高德地图脚本加载成功等待队列，成功之后依次触发\n */\nlet pendingResolveQueue: Array<() => void> = [];\n\n/**\n * AMapService\n */\n@injectable()\nexport default class AMapService\n  implements IMapService<AMap.Map & IAMapInstance> {\n  public version: string = Version['GAODE2.x'];\n  public simpleMapCoord: SimpleMapCoord = new SimpleMapCoord();\n  /**\n   * 原始地图实例\n   */\n  public map: AMap.Map & IAMapInstance;\n\n  /**\n   * 用于 customCooords 数据的计算\n   */\n  public sceneCenter!: [number, number]; // 一般使用用户数据的第一个\n  public sceneCenterMKT!: [number, number]; // 莫卡托\n\n  // 背景色\n  public bgColor: string = 'rgba(0, 0, 0, 0)';\n\n  @inject(TYPES.IGlobalConfigService)\n  private readonly configService: IGlobalConfigService;\n\n  @inject(TYPES.MapConfig)\n  private readonly config: Partial<IMapConfig>;\n\n  @inject(TYPES.ICoordinateSystemService)\n  private readonly coordinateSystemService: ICoordinateSystemService;\n\n  @inject(TYPES.IEventEmitter)\n  private eventEmitter: any;\n\n  private markerContainer: HTMLElement;\n  private $mapContainer: HTMLElement | null;\n\n  private viewport: Viewport;\n\n  private cameraChangedCallback: (viewport: IViewport) => void;\n  public setBgColor(color: string) {\n    this.bgColor = color;\n  }\n\n  /**\n   *   设置数据的绘制中心 高德2.0\n   */\n  public setCustomCoordCenter(center: [number, number]) {\n    this.sceneCenter = center;\n    // @ts-ignore\n    this.sceneCenterMKT = this.map\n      // @ts-ignore\n      .getProjection()\n      .project(...this.sceneCenter);\n  }\n\n  public getCustomCoordCenter(): [number, number] {\n    return this.sceneCenterMKT;\n  }\n  /**\n   * 根据数据的绘制中心转换经纬度数据 高德2.0\n   */\n  public lngLatToCoord(lnglat: [number, number]) {\n    // @ts-ignore\n    const proj = this.map.getProjection();\n    const project = proj.project;\n    // 单点\n    if (!this.sceneCenter) {\n      // @ts-ignore\n      this.map.customCoords.setCenter(lnglat);\n      this.setCustomCoordCenter(lnglat);\n    }\n    return this._sub(project(lnglat[0], lnglat[1]), this.sceneCenterMKT);\n  }\n\n  /**\n   * 转化线、面类型的点位数据\n   */\n  public lngLatToCoords(\n    lnglatArray: number[][][] | number[][],\n  ): number[][][] | number[][] {\n    // @ts-ignore\n    return lnglatArray.map((lnglats) => {\n      if (typeof lnglats[0] === 'number') {\n        return this.lngLatToCoord(lnglats as [number, number]);\n      } else {\n        // @ts-ignore\n        return lnglats.map((lnglat) => {\n          return this.lngLatToCoord(lnglat as [number, number]);\n        });\n      }\n    });\n  }\n\n  public addMarkerContainer(): void {\n    if (!this.map) {\n      return;\n    }\n    const mapContainer = this.map.getContainer();\n    if (mapContainer !== null) {\n      const amap = mapContainer.getElementsByClassName(\n        'amap-maps',\n      )[0] as HTMLElement;\n      // TODO: amap2 的 amap-maps 新增 z-index=0; 样式，让 marker 中 zIndex 失效\n      amap.style.zIndex = 'auto';\n      this.markerContainer = DOM.create('div', 'l7-marker-container2', amap);\n      // this.markerContainer = DOM.create(\n      //   'div',\n      //   'l7-marker-container2',\n      //   mapContainer,\n      // );\n      // this.markerContainer = mapContainer;\n    }\n  }\n  public getMarkerContainer(): HTMLElement {\n    return this.markerContainer;\n  }\n\n  //  map event\n  public on(type: string, handler: (...args: any[]) => void): void {\n    if (MapServiceEvent.indexOf(type) !== -1) {\n      this.eventEmitter.on(type, handler);\n    } else {\n      this.map.on(type, handler);\n    }\n  }\n  public off(type: string, handler: (...args: any[]) => void): void {\n    if (MapServiceEvent.indexOf(type) !== -1) {\n      this.eventEmitter.off(type, handler);\n    } else {\n      this.map.off(type, handler);\n    }\n  }\n\n  public getContainer(): HTMLElement | null {\n    return this.map.getContainer();\n  }\n\n  public getMapCanvasContainer(): HTMLElement {\n    return this.map\n      .getContainer()\n      ?.getElementsByClassName('amap-maps')[0] as HTMLElement;\n  }\n\n  public getSize(): [number, number] {\n    const size = this.map.getSize();\n    return [size.getWidth(), size.getHeight()];\n  }\n\n  public getType() {\n    return 'amap2';\n  }\n  public getZoom(): number {\n    // 统一返回 Mapbox 缩放等级\n    return this.map.getZoom() - 1;\n  }\n\n  public setZoom(zoom: number): void {\n    // 统一设置 Mapbox 缩放等级\n    return this.map.setZoom(zoom + 1);\n  }\n\n  public getCenter(options?: ICameraOptions): ILngLat {\n    if (options?.padding) {\n      const originCenter = this.getCenter();\n      const [w, h] = this.getSize();\n      const padding = toPaddingOptions(options.padding);\n      const px = this.lngLatToPixel([originCenter.lng, originCenter.lat]);\n      const offsetPx = [\n        (padding.right - padding.left) / 2,\n        (padding.bottom - padding.top) / 2,\n      ];\n\n      const newCenter = this.pixelToLngLat([\n        px.x - offsetPx[0],\n        px.y - offsetPx[1],\n      ]);\n      return newCenter;\n    }\n    const center = this.map.getCenter();\n    return {\n      lng: center.getLng(),\n      lat: center.getLat(),\n    };\n  }\n  public setCenter(lnglat: [number, number], options?: ICameraOptions): void {\n    if (options?.padding) {\n      const padding = toPaddingOptions(options.padding);\n      const px = this.lngLatToPixel(lnglat);\n      const offsetPx = [\n        (padding.right - padding.left) / 2,\n        (padding.bottom - padding.top) / 2,\n      ];\n      const newCenter = this.pixelToLngLat([\n        px.x + offsetPx[0],\n        px.y + offsetPx[1],\n      ]);\n      this.map.setCenter([newCenter.lng, newCenter.lat]);\n    } else {\n      this.map.setCenter(lnglat);\n    }\n  }\n  public getPitch(): number {\n    return this.map.getPitch();\n  }\n\n  public getRotation(): number {\n    // 统一返回逆时针旋转角度\n    return 360 - this.map.getRotation();\n  }\n\n  public getBounds(): Bounds {\n    // @ts-ignore\n    // const amapBound = this.map.getBounds().toBounds();\n    // const NE = amapBound.getNorthEast();\n    // const SW = amapBound.getSouthWest();\n    const bounds = this.map.getBounds();\n\n    // @ts-ignore\n    const NE = bounds.getNorthEast();\n    // @ts-ignore\n    const SW = bounds.getSouthWest();\n    const center = this.getCenter();\n    const maxlng =\n      center.lng > NE.getLng() || center.lng < SW.getLng()\n        ? 180 - NE.getLng()\n        : NE.getLng();\n    const minlng = center.lng < SW.getLng() ? SW.getLng() - 180 : SW.getLng();\n    // 兼容 Mapbox，统一返回西南、东北\n    return [\n      [minlng, SW.getLat()],\n      [maxlng, NE.getLat()],\n    ];\n  }\n\n  public getMinZoom(): number {\n    // const zooms = this.map.get('zooms') as [number, number];\n    // @ts-ignore\n    const zooms = this.map.getZooms() as [number, number];\n    return zooms[0] - 1;\n  }\n  public getMaxZoom(): number {\n    // const zooms = this.map.get('zooms') as [number, number];\n    // @ts-ignore\n    const zooms = this.map.getZooms() as [number, number];\n    return zooms[1] - 1;\n  }\n  public setRotation(rotation: number): void {\n    return this.map.setRotation(rotation);\n  }\n\n  public setPitch(pitch: number) {\n    return this.map.setPitch(pitch);\n  }\n  public zoomIn(): void {\n    this.map.zoomIn();\n  }\n\n  public zoomOut(): void {\n    this.map.zoomOut();\n  }\n\n  public panTo(p: [number, number]): void {\n    this.map.panTo(p);\n  }\n  public panBy(x: number = 0, y: number = 0): void {\n    this.map.panBy(x, y);\n  }\n  public fitBounds(extent: Bounds): void {\n    this.map.setBounds(\n      new AMap.Bounds([extent[0][0], extent[0][1], extent[1][0], extent[1][1]]),\n    );\n  }\n  public setZoomAndCenter(zoom: number, center: [number, number]): void {\n    this.map.setZoomAndCenter(zoom, center);\n  }\n  public setMapStyle(style: string): void {\n    this.map.setMapStyle(this.getMapStyle(style));\n  }\n\n  public setMapStatus(option: Partial<IStatusOptions>): void {\n    this.map.setStatus(option);\n  }\n  public pixelToLngLat(pixel: [number, number]): ILngLat {\n    const lngLat = this.map.pixelToLngLat(new AMap.Pixel(pixel[0], pixel[1]));\n    return { lng: lngLat.getLng(), lat: lngLat.getLat() };\n  }\n  public lngLatToPixel(lnglat: [number, number]): IPoint {\n    const p = this.map.lnglatToPixel(new AMap.LngLat(lnglat[0], lnglat[1]));\n    return {\n      x: p.getX(),\n      y: p.getY(),\n    };\n  }\n  public containerToLngLat(pixel: [number, number]): ILngLat {\n    const ll = new AMap.Pixel(pixel[0], pixel[1]);\n    const lngLat = this.map.containerToLngLat(ll);\n    return {\n      lng: lngLat?.getLng(),\n      lat: lngLat?.getLat(),\n    };\n  }\n  public lngLatToContainer(lnglat: [number, number]): IPoint {\n    const ll = new AMap.LngLat(lnglat[0], lnglat[1]);\n    const pixel = this.map.lngLatToContainer(ll);\n    return {\n      x: pixel.getX(),\n      y: pixel.getY(),\n    };\n  }\n\n  public lngLatToMercator(\n    lnglat: [number, number],\n    altitude: number,\n  ): IMercator {\n    return {\n      x: 0,\n      y: 0,\n      z: 0,\n    };\n  }\n\n  public getModelMatrix(\n    lnglat: [number, number],\n    altitude: number,\n    rotate: [number, number, number],\n    scale: [number, number, number] = [1, 1, 1],\n    origin: IMercator = { x: 0, y: 0, z: 0 },\n  ): number[] {\n    // const flat = this.viewport.projectFlat(lnglat);\n    // @ts-ignore\n    const flat = this.map.customCoords.lngLatToCoord(lnglat);\n    // @ts-ignore\n    const modelMatrix = mat4.create();\n\n    mat4.translate(\n      modelMatrix,\n      modelMatrix,\n      vec3.fromValues(flat[0], flat[1], altitude),\n    );\n\n    mat4.scale(\n      modelMatrix,\n      modelMatrix,\n      vec3.fromValues(scale[0], scale[1], scale[2]),\n    );\n\n    mat4.rotateX(modelMatrix, modelMatrix, rotate[0]);\n    mat4.rotateY(modelMatrix, modelMatrix, rotate[1]);\n    mat4.rotateZ(modelMatrix, modelMatrix, rotate[2]);\n\n    return (modelMatrix as unknown) as number[];\n  }\n  public async init(): Promise<void> {\n    const {\n      id,\n      style = 'light',\n      minZoom = 0,\n      maxZoom = 18,\n      token = AMAP_API_KEY,\n      mapInstance,\n      plugin = [],\n      version = AMAP_VERSION,\n      ...rest\n    } = this.config;\n    // 高德地图创建独立的container；\n    // tslint:disable-next-line:typedef\n    await new Promise<void>((resolve) => {\n      const resolveMap = () => {\n        if (mapInstance) {\n          this.map = mapInstance as AMap.Map & IAMapInstance;\n          this.$mapContainer = this.map.getContainer();\n\n          // 在使用 map.customCoords 的时候必须使用\n          const mapInitCenter = this.map.getCenter();\n          // @ts-ignore\n          this.map.customCoords?.setCenter([\n            // @ts-ignore\n            mapInitCenter.lng,\n            // @ts-ignore\n            mapInitCenter.lat,\n          ]);\n          // @ts-ignore\n          this.setCustomCoordCenter([mapInitCenter.lng, mapInitCenter.lat]);\n\n          setTimeout(() => {\n            this.map.on('viewchange', this.handleViewChanged);\n            resolve();\n          }, 30);\n        } else {\n          this.$mapContainer = this.creatAmapContainer(\n            id as string | HTMLDivElement,\n          );\n          const mapConstructorOptions = {\n            mapStyle: this.getMapStyle(style as string),\n            zooms: [minZoom, maxZoom],\n            viewMode: '3D',\n            ...rest,\n          };\n          if (mapConstructorOptions.zoom) {\n            // TODO: 高德地图在相同大小下需要比 MapBox 多一个 zoom 层级\n            mapConstructorOptions.zoom += 1;\n          }\n          // @ts-ignore\n          const map = new AMap.Map(this.$mapContainer, mapConstructorOptions);\n          // @ts-ignore\n          this.map = map;\n          // 在使用 map.customCoords 的时候必须使用\n          const mapInitCenter = map.getCenter();\n          // @ts-ignore\n          map.customCoords.setCenter([mapInitCenter.lng, mapInitCenter.lat]);\n          // @ts-ignore\n          this.setCustomCoordCenter([mapInitCenter.lng, mapInitCenter.lat]);\n          // 监听地图相机事件\n          map.on('viewchange', this.handleViewChanged);\n\n          setTimeout(() => {\n            resolve();\n          }, 10);\n        }\n      };\n      this.viewport = new Viewport();\n      if (!amapLoaded && !mapInstance) {\n        if (token === AMAP_API_KEY) {\n          console.warn(this.configService.getSceneWarninfo('MapToken'));\n        }\n        amapLoaded = true;\n        plugin.push('Map3D');\n        AMapLoader.load({\n          key: token, // 申请好的Web端开发者Key，首次调用 load 时必填\n          version, // 指定要加载的 JSAPI 的版本，缺省时默认为 1.4.15\n          plugins: plugin, // 需要使用的的插件列表，如比例尺'AMap.Scale'等\n        })\n          .then((AMap) => {\n            resolveMap();\n            if (pendingResolveQueue.length) {\n              pendingResolveQueue.forEach((r) => r());\n              pendingResolveQueue = [];\n            }\n          })\n          .catch((e) => {\n            throw new Error(e);\n          });\n      } else {\n        if ((amapLoaded && window.AMap) || mapInstance) {\n          resolveMap();\n        } else {\n          pendingResolveQueue.push(resolveMap);\n        }\n      }\n    });\n  }\n\n  public meterToCoord(center: [number, number], outer: [number, number]) {\n    // 统一根据经纬度来转化\n    // Tip: 实际米距离 unit meter\n    const meterDis = AMap.GeometryUtil.distance(\n      new AMap.LngLat(...center),\n      new AMap.LngLat(...outer),\n    );\n\n    // Tip: 三维世界坐标距离\n    const [x1, y1] = this.lngLatToCoord(center);\n    const [x2, y2] = this.lngLatToCoord(outer);\n    const coordDis = Math.sqrt(Math.pow(x1 - x2, 2) + Math.pow(y1 - y2, 2));\n\n    return coordDis / meterDis;\n  }\n\n  public exportMap(type: 'jpg' | 'png'): string {\n    const renderCanvas = this.getContainer()?.getElementsByClassName(\n      'amap-layer',\n    )[0] as HTMLCanvasElement;\n    const layersPng =\n      type === 'jpg'\n        ? (renderCanvas?.toDataURL('image/jpeg') as string)\n        : (renderCanvas?.toDataURL('image/png') as string);\n    return layersPng;\n  }\n\n  public emit(name: string, ...args: any[]) {\n    this.eventEmitter.emit(name, ...args);\n  }\n\n  public once(name: string, ...args: any[]) {\n    this.eventEmitter.once(name, ...args);\n  }\n\n  public destroy() {\n    this.map.destroy();\n\n    // TODO: 销毁地图可视化层的容器\n    this.$mapContainer?.parentNode?.removeChild(this.$mapContainer);\n\n    // @ts-ignore\n    delete window.initAMap;\n    const $jsapi = document.getElementById(AMAP_SCRIPT_ID);\n    if ($jsapi) {\n      document.head.removeChild($jsapi);\n    }\n  }\n\n  public getMapContainer() {\n    return this.$mapContainer;\n  }\n\n  public onCameraChanged(callback: (viewport: IViewport) => void): void {\n    this.cameraChangedCallback = callback;\n  }\n\n  public initViewPort() {\n    // @ts-ignore\n    const {\n      // @ts-ignore\n      fov,\n      // @ts-ignore\n      near,\n      // @ts-ignore\n      far,\n      // @ts-ignore\n      aspect,\n      // @ts-ignore\n      position,\n      // @ts-ignore\n      lookAt,\n      // @ts-ignore\n      up,\n      // @ts-ignore\n      // left, right, bottom, top\n      // @ts-ignore\n    } = this.map.customCoords?.getCameraParams();\n    // Tip: 统一触发地图变化事件\n    this.emit('mapchange');\n    // // @ts-ignore\n    // console.log('this.map.customCoords.getCameraParams()', this.map.customCoords.getCameraParams())\n    // const { left, right, bottom, top, near, far, position } = this.map.customCoords.getCameraParams();\n\n    // @ts-ignore\n    const center = this.map.customCoords.getCenter() as [number, number];\n    const zoom = this.map.getZoom();\n    // @ts-ignore\n    if (this.cameraChangedCallback) {\n      this.viewport.syncWithMapCamera({\n        aspect,\n        far,\n        fov,\n        cameraPosition: position,\n        lookAt,\n        near,\n        up,\n        // AMap 定义的缩放等级 与 Mapbox 相差 1\n        zoom: zoom - 1, // 与amap1.x对比相差一个级别\n        center,\n        offsetOrigin: [position[0], position[1]],\n\n        // @ts-ignore\n        // left, right, bottom, top\n      });\n      // set coordinate system\n      this.coordinateSystemService.setCoordinateSystem(CoordinateSystem.P20_2);\n      this.cameraChangedCallback(this.viewport);\n    }\n  }\n\n  private _sub(a: number[] | vec3 | vec2, b: number[]): [number, number] {\n    const r: [number, number] = [0, 0];\n    r[0] = a[0] - b[0];\n    r[1] = a[1] - b[1];\n    return r;\n  }\n\n  /**\n   *\n   * @param e\n   */\n  private handleViewChanged = (e: any): void => {\n    const {\n      // @ts-ignore\n      fov,\n      // @ts-ignore\n      near,\n      // @ts-ignore\n      far,\n      // @ts-ignore\n      aspect,\n      // @ts-ignore\n      position,\n      // @ts-ignore\n      lookAt,\n      // @ts-ignore\n      up,\n      // @ts-ignore\n      // left, right, bottom, top\n      // @ts-ignore\n    } = this.map.customCoords.getCameraParams();\n    // Tip: 统一触发地图变化事件\n    this.emit('mapchange');\n\n    const { zoom } = e;\n    // @ts-ignore\n    const center = this.map.customCoords.getCenter() as [number, number];\n    if (this.cameraChangedCallback) {\n      // resync viewport\n      this.viewport.syncWithMapCamera({\n        aspect,\n        far,\n        fov,\n        cameraPosition: position,\n        lookAt,\n        up,\n        near,\n        // AMap 定义的缩放等级 与 Mapbox 相差 1\n        zoom: zoom - 1, // 与amap1.x对比相差一个级别\n        center,\n        offsetOrigin: [position[0], position[1]],\n\n        // @ts-ignore\n        // left, right, bottom, top\n      });\n      // set coordinate system\n      this.coordinateSystemService.setCoordinateSystem(CoordinateSystem.P20_2);\n      this.cameraChangedCallback(this.viewport);\n    }\n  };\n\n  private getMapStyle(name: string): string {\n    return MapTheme[name] ? MapTheme[name] : name;\n  }\n\n  private creatAmapContainer(id: string | HTMLDivElement) {\n    let $wrapper = id as HTMLDivElement;\n    if (typeof id === 'string') {\n      $wrapper = document.getElementById(id) as HTMLDivElement;\n    }\n    const $amapdiv = document.createElement('div');\n    $amapdiv.style.cssText += `\n      position: absolute;\n      top: 0;\n      height: 100%;\n      width: 100%;\n    `;\n    $amapdiv.id = 'l7_amap_div' + mapdivCount++;\n    $wrapper.appendChild($amapdiv);\n    return $amapdiv;\n  }\n}\n"],"file":"map.js"}