{"version":3,"sources":["../../src/map/map.ts"],"names":["CoordinateSystem","MapServiceEvent","TYPES","Map","$window","DOM","inject","injectable","SimpleMapCoord","Version","Viewport","EventMap","mapmove","camerachange","zoomchange","dragging","MapTheme","LNGLAT_OFFSET_ZOOM_THRESHOLD","L7MapService","MapConfig","IGlobalConfigService","ICoordinateSystemService","IEventEmitter","L7MAP","lng","lat","zoom","bearing","pitch","config","offsetCoordinate","viewport","syncWithMapCamera","center","viewportHeight","map","transform","height","viewportWidth","width","cameraHeight","getZoom","coordinateSystemService","setCoordinateSystem","LNGLAT_OFFSET","LNGLAT","cameraChangedCallback","getCenter","emit","getBearing","getPitch","color","bgColor","container","getCanvasContainer","markerContainer","create","setAttribute","type","handle","indexOf","eventEmitter","on","off","getContainer","version","SIMPLE","simpleMapCoord","getSize","size","setZoom","lnglat","setCenter","getBounds","toArray","getMinZoom","getMaxZoom","rotation","setBearing","option","eventData","zoomIn","zoomOut","setPitch","p","panTo","x","y","bound","fitBoundsOptions","fitBounds","max","setMaxZoom","min","setMinZoom","doubleClickZoom","enable","disable","dragEnable","dragPan","rotateEnable","dragRotate","keyboardEnable","keyboard","zoomEnable","scrollZoom","flyTo","style","setStyle","getMapStyle","pixel","unproject","project","altitude","Error","rotate","scale","origin","z","id","attributionControl","mapInstance","mapSize","rest","setSize","$mapContainer","creatAmapContainer","handleCameraChanged","canvas","hasBaseMap","handleMiniCameraChanged","document","addEventListener","event","e","longitude","latitude","parentNode","removeChild","removeAllListeners","remove","name","args","once","renderCanvas","getCanvas","layersPng","toDataURL","callback","$wrapper","getElementById"],"mappings":"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","sourcesContent":["/**\n * MapboxService\n */\nimport {\n  Bounds,\n  CoordinateSystem,\n  ICoordinateSystemService,\n  IGlobalConfigService,\n  ILngLat,\n  IMapConfig,\n  IMapService,\n  IMercator,\n  IPoint,\n  IStatusOptions,\n  IViewport,\n  MapServiceEvent,\n  MapStyle,\n  TYPES,\n} from '@antv/l7-core';\nimport { Map } from '@antv/l7-map';\nimport { $window, DOM } from '@antv/l7-utils';\nimport { inject, injectable } from 'inversify';\nimport 'reflect-metadata';\nimport { ISimpleMapCoord, SimpleMapCoord } from '../simpleMapCoord';\nimport { Version } from '../version';\nimport Viewport from './Viewport';\nconst EventMap: {\n  [key: string]: any;\n} = {\n  mapmove: 'move',\n  camerachange: 'move',\n  zoomchange: 'zoom',\n  dragging: 'drag',\n};\nimport { MapTheme } from './theme';\n\nconst LNGLAT_OFFSET_ZOOM_THRESHOLD = 12;\n/**\n * AMapService\n */\n@injectable()\nexport default class L7MapService implements IMapService<Map> {\n  public version: string = Version.L7MAP;\n  public map: Map;\n  public simpleMapCoord: ISimpleMapCoord = new SimpleMapCoord();\n  // 背景色\n  public bgColor: string = 'rgba(0.0, 0.0, 0.0, 0.0)';\n\n  @inject(TYPES.MapConfig)\n  private readonly config: Partial<IMapConfig>;\n\n  @inject(TYPES.IGlobalConfigService)\n  private readonly configService: IGlobalConfigService;\n\n  @inject(TYPES.ICoordinateSystemService)\n  private readonly coordinateSystemService: ICoordinateSystemService;\n\n  @inject(TYPES.IEventEmitter)\n  private eventEmitter: any;\n  private viewport: Viewport;\n  private markerContainer: HTMLElement;\n  private cameraChangedCallback: (viewport: IViewport) => void;\n  private $mapContainer: HTMLElement | null;\n  public setBgColor(color: string) {\n    this.bgColor = color;\n  }\n\n  // init\n  public addMarkerContainer(): void {\n    const container = this.map.getCanvasContainer();\n    this.markerContainer = DOM.create('div', 'l7-marker-container', container);\n    this.markerContainer.setAttribute('tabindex', '-1');\n  }\n\n  public getMarkerContainer(): HTMLElement {\n    return this.markerContainer;\n  }\n\n  //  map event\n  public on(type: string, handle: (...args: any[]) => void): void {\n    if (MapServiceEvent.indexOf(type) !== -1) {\n      this.eventEmitter.on(type, handle);\n    } else {\n      // 统一事件名称\n      this.map.on(EventMap[type] || type, handle);\n    }\n  }\n  public off(type: string, handle: (...args: any[]) => void): void {\n    this.map.off(EventMap[type] || type, handle);\n    this.eventEmitter.off(type, handle);\n  }\n\n  public getContainer(): HTMLElement | null {\n    return this.map.getContainer();\n  }\n\n  public getMapCanvasContainer(): HTMLElement {\n    return this.map.getCanvasContainer() as HTMLElement;\n  }\n\n  public getSize(): [number, number] {\n    if (this.version === Version.SIMPLE) {\n      return this.simpleMapCoord.getSize();\n    }\n    const size = this.map.transform;\n    return [size.width, size.height];\n  }\n  // get mapStatus method\n\n  public getType() {\n    return 'default';\n  }\n\n  public getZoom(): number {\n    return this.map.getZoom();\n  }\n\n  public setZoom(zoom: number) {\n    return this.map.setZoom(zoom);\n  }\n\n  public getCenter(): ILngLat {\n    return this.map.getCenter();\n  }\n\n  public setCenter(lnglat: [number, number]): void {\n    this.map.setCenter(lnglat);\n  }\n\n  public getPitch(): number {\n    return this.map.getPitch();\n  }\n\n  public getRotation(): number {\n    return this.map.getBearing();\n  }\n\n  public getBounds(): Bounds {\n    return this.map.getBounds().toArray() as Bounds;\n  }\n\n  public getMinZoom(): number {\n    return this.map.getMinZoom();\n  }\n\n  public getMaxZoom(): number {\n    return this.map.getMaxZoom();\n  }\n\n  public setRotation(rotation: number): void {\n    this.map.setBearing(rotation);\n  }\n\n  public zoomIn(option?: any, eventData?: any): void {\n    this.map.zoomIn(option, eventData);\n  }\n  public zoomOut(option?: any, eventData?: any): void {\n    this.map.zoomOut(option, eventData);\n  }\n  public setPitch(pitch: number) {\n    return this.map.setPitch(pitch);\n  }\n\n  public panTo(p: [number, number]): void {\n    this.map.panTo(p);\n  }\n\n  public panBy(x: number = 0, y: number = 0): void {\n    this.panTo([x, y]);\n  }\n\n  public fitBounds(bound: Bounds, fitBoundsOptions?: any): void {\n    this.map.fitBounds(bound, fitBoundsOptions);\n  }\n\n  public setMaxZoom(max: number): void {\n    this.map.setMaxZoom(max);\n  }\n\n  public setMinZoom(min: number): void {\n    this.map.setMinZoom(min);\n  }\n  public setMapStatus(option: Partial<IStatusOptions>): void {\n    if (option.doubleClickZoom === true) {\n      this.map.doubleClickZoom.enable();\n    }\n    if (option.doubleClickZoom === false) {\n      this.map.doubleClickZoom.disable();\n    }\n    if (option.dragEnable === false) {\n      this.map.dragPan.disable();\n    }\n    if (option.dragEnable === true) {\n      this.map.dragPan.enable();\n    }\n    if (option.rotateEnable === false) {\n      this.map.dragRotate.disable();\n    }\n    if (option.dragEnable === true) {\n      this.map.dragRotate.enable();\n    }\n    if (option.keyboardEnable === false) {\n      this.map.keyboard.disable();\n    }\n    if (option.keyboardEnable === true) {\n      this.map.keyboard.enable();\n    }\n    if (option.zoomEnable === false) {\n      this.map.scrollZoom.disable();\n    }\n    if (option.zoomEnable === true) {\n      this.map.scrollZoom.enable();\n    }\n  }\n\n  public setZoomAndCenter(zoom: number, center: [number, number]): void {\n    this.map.flyTo({\n      zoom,\n      center,\n    });\n  }\n\n  public setMapStyle(style: any): void {\n    this.map.setStyle(this.getMapStyle(style));\n  }\n  // TODO: 计算像素坐标\n  public pixelToLngLat(pixel: [number, number]): ILngLat {\n    return this.map.unproject(pixel);\n  }\n\n  public lngLatToPixel(lnglat: [number, number]): IPoint {\n    return this.map.project(lnglat);\n  }\n\n  public containerToLngLat(pixel: [number, number]): ILngLat {\n    return this.map.unproject(pixel);\n  }\n\n  public lngLatToContainer(lnglat: [number, number]): IPoint {\n    return this.map.project(lnglat);\n  }\n  public lngLatToMercator(\n    lnglat: [number, number],\n    altitude: number,\n  ): IMercator {\n    throw new Error('not implement');\n  }\n  public getModelMatrix(\n    lnglat: [number, number],\n    altitude: number,\n    rotate: [number, number, number],\n    scale: [number, number, number] = [1, 1, 1],\n    origin: IMercator = { x: 0, y: 0, z: 0 },\n  ): number[] {\n    throw new Error('not implement');\n  }\n\n  public async init(): Promise<void> {\n    const {\n      id = 'map',\n      attributionControl = false,\n      style = 'light',\n      rotation = 0,\n      mapInstance,\n      version = 'L7MAP',\n      mapSize = 10000,\n      ...rest\n    } = this.config;\n\n    this.viewport = new Viewport();\n\n    this.version = version;\n    this.simpleMapCoord.setSize(mapSize);\n    // console.log('this.config.center', this.config.center)\n    if (version === Version.SIMPLE && rest.center) {\n      rest.center = this.simpleMapCoord.unproject(\n        rest.center as [number, number],\n      );\n    }\n    // console.log(this.simpleMapCoord.project(this.config.center as [number, number]))\n    // console.log(this.simpleMapCoord.unproject([500, 500]))\n    // console.log(this.simpleMapCoord.project([0, 0]))\n    // console.log(this.simpleMapCoord.unproject([5000, 5000]))\n\n    // console.log(this.simpleMapCoord.unproject([200, 200]))\n    // console.log(this.simpleMapCoord.unproject([1000, 1000]))\n\n    if (mapInstance) {\n      // @ts-ignore\n      this.map = mapInstance;\n      this.$mapContainer = this.map.getContainer();\n    } else {\n      this.$mapContainer = this.creatAmapContainer(id);\n      // @ts-ignore\n      this.map = new Map({\n        container: this.$mapContainer,\n        style: this.getMapStyle(style),\n        bearing: rotation,\n        ...rest,\n      });\n    }\n\n    this.map.on('load', this.handleCameraChanged);\n    this.map.on('move', this.handleCameraChanged);\n\n    // 不同于高德地图，需要手动触发首次渲染\n    this.handleCameraChanged();\n  }\n\n  // 初始化小程序地图\n  public async initMiniMap(): Promise<void> {\n    const {\n      id = 'map',\n      attributionControl = false,\n      style = 'light',\n      rotation = 0,\n      mapInstance,\n      canvas = null,\n      hasBaseMap = false,\n      ...rest\n    } = this.config;\n\n    this.viewport = new Viewport();\n\n    this.$mapContainer = canvas;\n\n    this.map = new Map({\n      container: this.$mapContainer as HTMLElement,\n      style: this.getMapStyle(style),\n      bearing: rotation,\n      // @ts-ignore\n      canvas,\n      ...rest,\n    });\n\n    if (!hasBaseMap) {\n      // 没有地图底图的模式\n      this.map.on('load', this.handleCameraChanged);\n      this.map.on('move', this.handleCameraChanged);\n\n      // 不同于高德地图，需要手动触发首次渲染\n      this.handleCameraChanged();\n    } else {\n      // 存在地图底图的模式（ L7Mini ）\n      const center = this.map.getCenter();\n      // 不同于高德地图，需要手动触发首次渲染\n      this.handleMiniCameraChanged(\n        center.lng,\n        center.lat,\n        this.map.getZoom(),\n        this.map.getBearing(),\n        this.map.getPitch(),\n      );\n      $window.document.addEventListener('mapCameaParams', (event: any) => {\n        const {\n          e: { longitude, latitude, scale, bearing, pitch },\n        } = event;\n        this.handleMiniCameraChanged(\n          longitude,\n          latitude,\n          scale - 1.25,\n          bearing,\n          pitch,\n        );\n      });\n    }\n  }\n\n  public destroy() {\n    // TODO: 销毁地图可视化层的容器\n    this.$mapContainer?.parentNode?.removeChild(this.$mapContainer);\n\n    this.eventEmitter.removeAllListeners();\n    if (this.map) {\n      this.map.remove();\n      this.$mapContainer = null;\n    }\n  }\n  public emit(name: string, ...args: any[]) {\n    this.eventEmitter.emit(name, ...args);\n  }\n  public once(name: string, ...args: any[]) {\n    this.eventEmitter.once(name, ...args);\n  }\n\n  public getMapContainer() {\n    return this.$mapContainer;\n  }\n\n  public exportMap(type: 'jpg' | 'png'): string {\n    const renderCanvas = this.map.getCanvas();\n    const layersPng =\n      type === 'jpg'\n        ? (renderCanvas?.toDataURL('image/jpeg') as string)\n        : (renderCanvas?.toDataURL('image/png') as string);\n    return layersPng;\n  }\n  public onCameraChanged(callback: (viewport: IViewport) => void): void {\n    this.cameraChangedCallback = callback;\n  }\n\n  // TODO: 处理小程序中有底图模式下的相机跟新\n  private handleMiniCameraChanged = (\n    lng: number,\n    lat: number,\n    zoom: number,\n    bearing: number,\n    pitch: number,\n  ) => {\n    const { offsetCoordinate = true } = this.config;\n\n    // resync\n    this.viewport.syncWithMapCamera({\n      // bearing: this.map.getBearing(),\n      bearing,\n      center: [lng, lat],\n      viewportHeight: this.map.transform.height,\n      // pitch: this.map.getPitch(),\n      pitch,\n      viewportWidth: this.map.transform.width,\n      zoom,\n      // mapbox 中固定相机高度为 viewport 高度的 1.5 倍\n      cameraHeight: 0,\n    });\n    // set coordinate system\n    if (\n      this.viewport.getZoom() > LNGLAT_OFFSET_ZOOM_THRESHOLD &&\n      offsetCoordinate\n    ) {\n      this.coordinateSystemService.setCoordinateSystem(\n        CoordinateSystem.LNGLAT_OFFSET,\n      );\n    } else {\n      this.coordinateSystemService.setCoordinateSystem(CoordinateSystem.LNGLAT);\n    }\n\n    this.cameraChangedCallback(this.viewport);\n  };\n\n  private handleCameraChanged = () => {\n    const { lat, lng } = this.map.getCenter();\n    const { offsetCoordinate = true } = this.config;\n    // Tip: 统一触发地图变化事件\n    this.emit('mapchange');\n    // resync\n    this.viewport.syncWithMapCamera({\n      bearing: this.map.getBearing(),\n      center: [lng, lat],\n      viewportHeight: this.map.transform.height,\n      pitch: this.map.getPitch(),\n      viewportWidth: this.map.transform.width,\n      zoom: this.map.getZoom(),\n      // mapbox 中固定相机高度为 viewport 高度的 1.5 倍\n      cameraHeight: 0,\n    });\n    // set coordinate system\n    if (\n      this.viewport.getZoom() > LNGLAT_OFFSET_ZOOM_THRESHOLD &&\n      offsetCoordinate\n    ) {\n      this.coordinateSystemService.setCoordinateSystem(\n        CoordinateSystem.LNGLAT_OFFSET,\n      );\n    } else {\n      this.coordinateSystemService.setCoordinateSystem(CoordinateSystem.LNGLAT);\n    }\n\n    this.cameraChangedCallback(this.viewport);\n  };\n\n  private creatAmapContainer(id: string | HTMLDivElement) {\n    let $wrapper = id as HTMLDivElement;\n    if (typeof id === 'string') {\n      $wrapper = document.getElementById(id) as HTMLDivElement;\n    }\n    return $wrapper;\n  }\n  private getMapStyle(name: MapStyle) {\n    if (typeof name !== 'string') {\n      return name;\n    }\n    return MapTheme[name] ? MapTheme[name] : name;\n  }\n}\n"],"file":"map.js"}