{"version":3,"sources":["../../../src/services/layer/StyleAttributeService.ts"],"names":["sleep","ms","Promise","resolve","setTimeout","bytesPerElementMap","gl","FLOAT","UNSIGNED_BYTE","UNSIGNED_SHORT","StyleAttributeService","TYPES","IRendererService","sizePerElement","elements","options","attributeToUpdate","getLayerStyleAttribute","name","setProps","StyleAttribute","attributes","push","attributeName","updateOptions","registerStyleAttribute","scale","needRescale","needRemapping","needRegenerateVertices","featureRange","find","attribute","scalers","func","features","startFeatureIdx","endFeatureIdx","descriptor","update","buffer","size","bytesPerElement","type","featureLayout","featuresToUpdate","slice","length","offset","bufferOffsetInBytes","updatedBufferData","map","attributeIdx","featureIdx","vertices","normals","verticesNumForCurrentFeature","featureData","vertexIdx","normal","reduce","prev","cur","vertexAttribute","updateBuffer","data","triangulation","segmentNumber","descriptors","attr","resetDescriptor","verticesNum","indices","forEach","feature","indicesForCurrentFeature","verticesForCurrentFeature","normalsForCurrentFeature","vertexSize","i","vertice","rendererService","createAttribute","createBuffer","createElements","rest","UNSIGNED_INT","count","attributesAndIndices","destroy"],"mappings":"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","sourcesContent":["import { inject, injectable, optional } from 'inversify';\nimport 'reflect-metadata';\nimport { TYPES } from '../../types';\nimport { gl } from '../renderer/gl';\nimport { IAttribute } from '../renderer/IAttribute';\nimport { IElements } from '../renderer/IElements';\nimport { IRendererService } from '../renderer/IRendererService';\nimport { IParseDataItem } from '../source/ISourceService';\nimport { ILayer } from './ILayerService';\nimport {\n  IAttributeScale,\n  IEncodeFeature,\n  IStyleAttribute,\n  IStyleAttributeInitializationOptions,\n  IStyleAttributeService,\n  IStyleAttributeUpdateOptions,\n  IVertexAttributeDescriptor,\n  Triangulation,\n} from './IStyleAttributeService';\nimport StyleAttribute from './StyleAttribute';\n\nfunction sleep(ms: number) {\n  return new Promise((resolve) => setTimeout(resolve, ms));\n}\n\nconst bytesPerElementMap = {\n  [gl.FLOAT]: 4,\n  [gl.UNSIGNED_BYTE]: 1,\n  [gl.UNSIGNED_SHORT]: 2,\n};\n\n/**\n * 每个 Layer 都拥有一个，用于管理样式属性的注册和更新\n */\n@injectable()\nexport default class StyleAttributeService implements IStyleAttributeService {\n  public attributesAndIndices: {\n    attributes: {\n      [attributeName: string]: IAttribute;\n    };\n    elements: IElements;\n  };\n  @inject(TYPES.IRendererService)\n  private readonly rendererService: IRendererService;\n\n  private attributes: IStyleAttribute[] = [];\n  private triangulation: Triangulation;\n\n  private featureLayout: {\n    sizePerElement: number;\n    elements: Array<{\n      featureIdx: number;\n      vertices: number[];\n      normals: number[];\n      offset: number;\n    }>;\n  } = {\n    sizePerElement: 0,\n    elements: [],\n  };\n  public registerStyleAttribute(\n    options: Partial<IStyleAttributeInitializationOptions>,\n  ) {\n    let attributeToUpdate = this.getLayerStyleAttribute(options.name || '');\n    if (attributeToUpdate) {\n      attributeToUpdate.setProps(options);\n    } else {\n      attributeToUpdate = new StyleAttribute(options);\n      this.attributes.push(attributeToUpdate);\n    }\n    return attributeToUpdate;\n  }\n\n  public updateStyleAttribute(\n    attributeName: string,\n    options: Partial<IStyleAttributeInitializationOptions>,\n    updateOptions?: Partial<IStyleAttributeUpdateOptions>,\n  ) {\n    let attributeToUpdate = this.getLayerStyleAttribute(attributeName);\n    if (!attributeToUpdate) {\n      attributeToUpdate = this.registerStyleAttribute({\n        ...options,\n        name: attributeName,\n      });\n    }\n    const { scale } = options;\n    if (scale && attributeToUpdate) {\n      // TODO: 需要比较新旧值确定是否需要 rescale\n      // 需要重新 scale，肯定也需要重新进行数据映射\n      attributeToUpdate.scale = scale;\n      attributeToUpdate.needRescale = true;\n      attributeToUpdate.needRemapping = true;\n      attributeToUpdate.needRegenerateVertices = true;\n      if (updateOptions && updateOptions.featureRange) {\n        attributeToUpdate.featureRange = updateOptions.featureRange;\n      }\n    }\n  }\n\n  public getLayerStyleAttributes(): IStyleAttribute[] | undefined {\n    return this.attributes;\n  }\n\n  public getLayerStyleAttribute(\n    attributeName: string,\n  ): IStyleAttribute | undefined {\n    return this.attributes.find(\n      (attribute) => attribute.name === attributeName,\n    );\n  }\n\n  public getLayerAttributeScale(name: string) {\n    const attribute = this.getLayerStyleAttribute(name);\n    const scale = attribute?.scale?.scalers as IAttributeScale[];\n    if (scale && scale[0]) {\n      return scale[0].func;\n    }\n    return null;\n  }\n\n  public updateAttributeByFeatureRange(\n    attributeName: string,\n    features: IEncodeFeature[],\n    startFeatureIdx: number = 0,\n    endFeatureIdx?: number,\n  ) {\n    const attributeToUpdate = this.attributes.find(\n      (attribute) => attribute.name === attributeName,\n    );\n    if (attributeToUpdate && attributeToUpdate.descriptor) {\n      const { descriptor } = attributeToUpdate;\n      const { update, buffer, size = 0 } = descriptor;\n      const bytesPerElement = bytesPerElementMap[buffer.type || gl.FLOAT];\n      if (update) {\n        const { elements, sizePerElement } = this.featureLayout;\n        // 截取待更新的 feature 范围\n        const featuresToUpdate = elements.slice(startFeatureIdx, endFeatureIdx);\n        // [n, n] 中断更新\n        if (!featuresToUpdate.length) {\n          return;\n        }\n        const { offset } = featuresToUpdate[0];\n        // 以 byte 为单位计算 buffer 中的偏移\n        const bufferOffsetInBytes = offset * size * bytesPerElement;\n        const updatedBufferData = featuresToUpdate\n          .map(({ featureIdx, vertices, normals }, attributeIdx) => {\n            const verticesNumForCurrentFeature =\n              vertices.length / sizePerElement;\n            const featureData: number[] = [];\n            for (\n              let vertexIdx = 0;\n              vertexIdx < verticesNumForCurrentFeature;\n              vertexIdx++\n            ) {\n              const normal = normals\n                ? normals!.slice(vertexIdx * 3, vertexIdx * 3 + 3)\n                : [];\n              featureData.push(\n                ...update(\n                  features[featureIdx],\n                  featureIdx,\n                  vertices.slice(\n                    vertexIdx * sizePerElement,\n                    vertexIdx * sizePerElement + sizePerElement,\n                  ),\n                  attributeIdx,\n                  normal,\n                ),\n              );\n            }\n            return featureData;\n          })\n          .reduce((prev, cur) => {\n            prev.push(...cur);\n            return prev;\n          }, []);\n\n        // 更新底层 IAttribute 中包含的 IBuffer，使用 subdata\n        attributeToUpdate.vertexAttribute.updateBuffer({\n          data: updatedBufferData,\n          offset: bufferOffsetInBytes,\n        });\n      }\n    }\n  }\n\n  public createAttributesAndIndices(\n    features: IEncodeFeature[],\n    triangulation: Triangulation,\n    segmentNumber: number,\n  ): {\n    attributes: {\n      [attributeName: string]: IAttribute;\n    };\n    elements: IElements;\n  } {\n    // 每次创建的初始化化 LayerOut\n    this.featureLayout = {\n      sizePerElement: 0,\n      elements: [],\n    };\n    if (triangulation) {\n      this.triangulation = triangulation;\n    }\n    const descriptors = this.attributes.map((attr) => {\n      attr.resetDescriptor();\n      return attr.descriptor;\n    });\n    let verticesNum = 0;\n    const vertices: number[] = [];\n    const indices: number[] = [];\n    const normals: number[] = [];\n    let size = 3;\n    features.forEach((feature, featureIdx) => {\n      // 逐 feature 进行三角化\n      const {\n        indices: indicesForCurrentFeature,\n        vertices: verticesForCurrentFeature,\n        normals: normalsForCurrentFeature,\n        size: vertexSize,\n      } = this.triangulation(feature, segmentNumber);\n      indicesForCurrentFeature.forEach((i) => {\n        indices.push(i + verticesNum);\n      });\n      size = vertexSize;\n      const verticesNumForCurrentFeature =\n        verticesForCurrentFeature.length / vertexSize;\n\n      // 记录三角化结果，用于后续精确更新指定 feature\n      this.featureLayout.sizePerElement = size;\n      this.featureLayout.elements.push({\n        featureIdx,\n        vertices: verticesForCurrentFeature,\n        normals: normalsForCurrentFeature as number[],\n        offset: verticesNum,\n      });\n\n      verticesNum += verticesNumForCurrentFeature;\n      // 根据 position 顶点生成其他顶点数据\n      for (\n        let vertexIdx = 0;\n        vertexIdx < verticesNumForCurrentFeature;\n        vertexIdx++\n      ) {\n        const normal =\n          normalsForCurrentFeature?.slice(vertexIdx * 3, vertexIdx * 3 + 3) ||\n          [];\n        const vertice = verticesForCurrentFeature.slice(\n          vertexIdx * vertexSize,\n          vertexIdx * vertexSize + vertexSize,\n        );\n        descriptors.forEach((descriptor, attributeIdx) => {\n          if (descriptor && descriptor.update) {\n            (descriptor.buffer.data as number[]).push(\n              ...descriptor.update(\n                feature,\n                featureIdx,\n                vertice,\n                vertexIdx, // 当前顶点所在feature索引\n                normal,\n                // TODO: 传入顶点索引 vertexIdx\n              ),\n            );\n          } // end if\n        }); // end for each\n      } // end for\n    }); // end features for Each\n    const {\n      createAttribute,\n      createBuffer,\n      createElements,\n    } = this.rendererService;\n\n    const attributes: {\n      [attributeName: string]: IAttribute;\n    } = {};\n    descriptors.forEach((descriptor, attributeIdx) => {\n      if (descriptor) {\n        // IAttribute 参数透传\n        const { buffer, update, name, ...rest } = descriptor;\n\n        const vertexAttribute = createAttribute({\n          // IBuffer 参数透传\n          buffer: createBuffer(buffer),\n          ...rest,\n        });\n        attributes[descriptor.name || ''] = vertexAttribute;\n\n        // 在 StyleAttribute 上保存对 VertexAttribute 的引用\n        this.attributes[attributeIdx].vertexAttribute = vertexAttribute;\n      }\n    });\n\n    const elements = createElements({\n      data: indices,\n      type: gl.UNSIGNED_INT,\n      count: indices.length,\n    });\n    this.attributesAndIndices = {\n      attributes,\n      elements,\n    };\n    return this.attributesAndIndices;\n  }\n  public clearAllAttributes() {\n    // 销毁关联的 vertex attribute buffer objects\n    this.attributes.forEach((attribute) => {\n      if (attribute.vertexAttribute) {\n        attribute.vertexAttribute.destroy();\n      }\n    });\n\n    this.attributesAndIndices?.elements.destroy();\n    this.attributes = [];\n  }\n}\n"],"file":"StyleAttributeService.js"}