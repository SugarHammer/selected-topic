{"version":3,"sources":["../../../src/services/layer/StyleAttribute.ts"],"names":["StyleAttribute","options","startIndex","endIndex","Infinity","params","length","scale","defaultValues","map","param","idx","scaleFunc","scalers","func","value","setProps","Object","assign","callback","ret","defaultCallback","descriptor","buffer","data"],"mappings":";;;;;;IAiBqBA,c;AA6BnB,0BAAYC,OAAZ,EAAoE;AAAA;;AAAA;;AAAA;;AAAA;;AAAA;;AAAA;;AAAA,iDAX/D,EAW+D;;AAAA,yCATtC,KASsC;;AAAA,2CARpC,KAQoC;;AAAA,oDAP3B,KAO2B;;AAAA,0CAN/B;AACnCC,MAAAA,UAAU,EAAE,CADuB;AAEnCC,MAAAA,QAAQ,EAAEC;AAFyB,KAM+B;;AAAA;;AAAA,6CA8B1C,UAACC,MAAD,EAAkC;AAE1D,UAAIA,MAAM,CAACC,MAAP,KAAkB,CAAtB,EAAyB;AAAA;;AACvB,eAAO,gBAAA,KAAI,CAACC,KAAL,4DAAYC,aAAZ,KAA6B,EAApC;AACD;;AACD,aAAOH,MAAM,CAACI,GAAP,CAAW,UAACC,KAAD,EAAQC,GAAR,EAAgB;AAAA;;AAChC,YAAMC,SAAS,mBAAG,KAAI,CAACL,KAAR,iDAAG,aAAYM,OAAZ,CAAqBF,GAArB,EAA0BG,IAA5C;AAEA,YAAMC,KAAK,GAAGH,SAAS,CAACF,KAAD,CAAvB;AACA,eAAOK,KAAP;AACD,OALM,CAAP;AAMD,KAzCmE;;AAClE,SAAKC,QAAL,CAAcf,OAAd;AACD;;;;WAED,kBAAgBA,OAAhB,EAAwE;AACtEgB,MAAAA,MAAM,CAACC,MAAP,CAAc,IAAd,EAAoBjB,OAApB;AACD;;;WAED,iBAAeI,MAAf,EAA6C;AAAA;;AAI3C,0BAAI,KAAKE,KAAT,yCAAI,aAAYY,QAAhB,EAA0B;AAAA;;AAExB,YAAMC,GAAG,mBAAG,KAAKb,KAAR,iDAAG,aAAYY,QAAZ,wCAAwBd,MAAxB,EAAZ;;AACA,YAAI,CAAC,OAAMe,GAAN,CAAL,EAAiB;AACf,iBAAO,CAACA,GAAD,CAAP;AACD;AACF;;AAGD,aAAO,KAAKC,eAAL,CAAqBhB,MAArB,CAAP;AACD;;;WAED,2BAAyB;AACvB,UAAI,KAAKiB,UAAT,EAAqB;AACnB,aAAKA,UAAL,CAAgBC,MAAhB,CAAuBC,IAAvB,GAA8B,EAA9B;AACD;AACF;;;;;;SAzDkBxB,c","sourcesContent":["import { isNil } from 'lodash';\nimport {\n  IAttributeScale,\n  IScaleOption,\n  IStyleAttribute,\n  StyleScaleType,\n} from '../layer/IStyleAttributeService';\nimport { IAttribute } from '../renderer/IAttribute';\nimport {\n  AttributeType,\n  IEncodeFeature,\n  IFeatureRange,\n  IStyleAttributeInitializationOptions,\n  IStyleScale,\n  IVertexAttributeDescriptor,\n} from './IStyleAttributeService';\n\nexport default class StyleAttribute implements IStyleAttribute {\n  public name: string;\n  public type: AttributeType;\n  public scale?: {\n    type: StyleScaleType.CONSTANT;\n    names: string[];\n    field: string | string[];\n    values: unknown[];\n    defaultValues: unknown[];\n    callback?: (...args: any[]) => [];\n    scalers?: IAttributeScale[];\n  };\n  public descriptor: IVertexAttributeDescriptor;\n  public featureBufferLayout: Array<{\n    feature: IEncodeFeature;\n    featureIdx: number;\n    bufferOffset: number;\n    length: number;\n  }> = [];\n\n  public needRescale: boolean = false;\n  public needRemapping: boolean = false;\n  public needRegenerateVertices: boolean = false;\n  public featureRange: IFeatureRange = {\n    startIndex: 0,\n    endIndex: Infinity,\n  };\n  public vertexAttribute: IAttribute;\n\n  constructor(options: Partial<IStyleAttributeInitializationOptions>) {\n    this.setProps(options);\n  }\n\n  public setProps(options: Partial<IStyleAttributeInitializationOptions>) {\n    Object.assign(this, options);\n  }\n\n  public mapping(params: unknown[]): unknown[] {\n    /**\n     * 当用户设置的 callback 返回 null 时, 应该返回默认 callback 中的值\n     */\n    if (this.scale?.callback) {\n      // 使用用户返回的值处理\n      const ret = this.scale?.callback(...params);\n      if (!isNil(ret)) {\n        return [ret];\n      }\n    }\n\n    // 没有 callback 或者用户 callback 返回值为空，则使用默认的逻辑处理\n    return this.defaultCallback(params);\n  }\n\n  public resetDescriptor() {\n    if (this.descriptor) {\n      this.descriptor.buffer.data = [];\n    }\n  }\n\n  private defaultCallback = (params: unknown[]): unknown[] => {\n    // 没有 params 的情况，是指没有指定 fields，直接返回配置的 values 常量\n    if (params.length === 0) {\n      return this.scale?.defaultValues || [];\n    }\n    return params.map((param, idx) => {\n      const scaleFunc = this.scale?.scalers![idx].func;\n      // @ts-ignore\n      const value = scaleFunc(param);\n      return value;\n    });\n  };\n}\n"],"file":"StyleAttribute.js"}